<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>RabbitMQ[复盘] | 卿云</title><meta name="keywords" content="系统架构,RabbitMQ,消息队列"><meta name="author" content="Flaw"><meta name="copyright" content="Flaw"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="RabbitMQ[复盘]"><meta name="application-name" content="RabbitMQ[复盘]"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="RabbitMQ[复盘]"><meta property="og:url" content="http://lisianthusw.github.io/2024/08/09/RabbitMQ%E7%9F%A5%E8%AF%86%E5%BA%93/index.html"><meta property="og:site_name" content="卿云"><meta property="og:description" content="1.1概述在项目中，可将一些无需即时返回且耗时的操作提取出来，进行异步处理，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而提高了**系统的吞吐量。 1.1.1 QPS概念QPS即每秒查询率，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。每秒查询率：因特网上，经常用每秒查询"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/17/17-54-55-image-20210717162752376-fb7887.png"><meta property="article:author" content="Flaw"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/17/17-54-55-image-20210717162752376-fb7887.png"><meta name="description" content="1.1概述在项目中，可将一些无需即时返回且耗时的操作提取出来，进行异步处理，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而提高了**系统的吞吐量。 1.1.1 QPS概念QPS即每秒查询率，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。每秒查询率：因特网上，经常用每秒查询"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://lisianthusw.github.io/2024/08/09/RabbitMQ%E7%9F%A5%E8%AF%86%E5%BA%93/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: {"appId":"LCING6Z89I","apiKey":"aaad301b93e4fcad31834c7191ae2cd5","indexName":"hexo_blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Flaw","link":"链接: ","source":"来源: 卿云","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '卿云',
  title: 'RabbitMQ[复盘]',
  postAI: '',
  pageFillDescription: '1.1概述, 1.1.1 QPS概念, 1.1.2PV UV PR, 1.2.消息队列应用场景, 1.2.1应用解耦, 1.2.2.异步处理, 1.2.3.流量削峰, 2.消息队列相关介绍, 2.2.1. AMQP, 2.2.2. JMS, 2.2.3. AMQP 与 JMS 区别, 2.2.4 RabbitMQ简介, 2.2.5 RabbitMQ 中的相关概念, 3.RabbitMQ安装及配置, 3.1下载包, 3.2安装, 1.安装Erlang、Socat、RabbitMQ, 2.启用管理插件, 3.启动RabbitMQ, 4.查看进程, 5.测试, 6.增加自定义账号, 7.卸载, 3.3管理界面, 4.AMQP, 4.1. 相关概念介绍, 4.2. RabbitMQ运转流程, 5.RabbitMQ入门案列, 5.1入门案列, 6.RabbitMQ工作模式, 6.1 简单模式, 6.1.1概述, 6.1.2 代码实现, 6.2 发布订阅模式, 6.2.1模式说明, 6.2.2 代码实现, 6.3Routing路由模式, 6.3.1模式说明, 6.3.2代码实现, 6.4 Topics通配符模式, 6.4.1模式说明, 6.4.2 代码实现, 6.5工作模式总结, 7.Spring整合RabbitMQ, 7.1 生产者端, 7.2.消费者端, 8.RabbitMQ高级特性, 8.1消息的可靠性传递（发送端）, 8.1.1 Confirm确认模式, 8.1.2 Return退回模式, 8.1.3消息的可靠投递小结, 8.1.4Consumer Ack（接收端）, 8.2消费限流, 8.3TTL, 8.3.1 配置队列过期时间, 8.3.2 消息过期时间, 8.4死信队列, 8.4.1什么是死信队列, 8.4.2 过期时间处理代码, 8.4.3 长度限制处理, 8.4.4消息拒收, 8.5 延迟队列, 9.SpringBoot集成MQ, 9.1整合, 9.1.2生产者, 9.1.3消费者, 9.1SpringBoot在消费端绑定, 10.消息百分百成功投递, 10.1 生产者端, 10.2 消费幂等性, 11.Springboot消息确认, 11.1 搭建环境, 11.2 生产端消息确认配置1, 11.3生产端消息确认配置（百分百发送）, 11.4发送消息, 11.5接收消息, 12.Springboot延迟队列, 12.1 基于死信实现延迟消息, 12.1.1消息的TTL（Time To Live）, 12.1.2死信交换机  Dead Letter Exchanges, 12.1.3 延迟队列的代码实现, 12.2基于延迟插件实现延迟消息, 12.2.1幂等性处理, 12.2.2 重试机制, 12.2.3 延迟消息发送封装, 12.3超时订单关闭, 概述在项目中可将一些无需即时返回且耗时的操作提取出来进行异步处理而这种异步处理的方式大大的节省了服务器的请求响应时间从而提高了系统的吞吐量概念即每秒查询率是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准每秒查询率因特网上经常用每秒查询率来衡量域名系统服务器的机器的性能即为或者理解每秒的响应请求数也即是最大吞吐能力计算关系并发量平均响应时间并发量平均响应时间原理每天的访问集中在的时间里这时间叫做峰值时间公式总数每天秒数峰值时间每秒请求数机器峰值时间每秒单台机器的需要的机器什么是即页面浏览量或点击量通常是衡量一个网络新闻频道或网站甚至一条网络新闻的主要指标对的解释是一个访问者在小时点到点内到底看了你网站几个页面这里需要强调同一个人浏览你网站同一个页面不重复计算量点次也算次说白了就是一个访问者打开了你的几个页面之于网站就像收视率之于电视从某种程度上已成为投资者衡量商业网站表现的最重要尺度的计算当一个访问者访问的时候记录他所访问的页面和对应的然后确定这个今天访问了这个页面没有如果你的网站到了点单纯有万条的话每个访问者平均访问了个页面那么表的记录就要有万条什么是指访问某个站点或点击某条新闻的不同地址的人数在同一天内只记录第一次进入网站的具有独立的访问者在同一天内再次访问该网站则不计数独立访问者提供了一定时间内不同观众数量的统计指标而没有反应出网站的全面活动什么是值值即网页的级别技术用来标识网页的等级重要性级别从到级级为满分值越高说明该网页越受欢迎越重要例如一个值为的网站表明这个网站不太具有流行度而值为到则表明这个网站非常受欢迎或者说极其重要消息队列应用场景应用解耦传统模式的缺点系统间耦合性太强如上图所示系统在代码中直接调用系统和系统的代码如果将来系统接入系统还需要修改代码过于麻烦中间件模式将消息写入消息队列需要消息的系统自己从消息队列中订阅从而系统不需要做任何修改异步处理用户注册后需要发注册邮件和注册短信传统的做法有两种串行的方式并行的方式串行方式将注册信息写入数据库后发送注册邮件再发送注册短信以上三个任务全部完成后才返回给客户端这有一个问题是邮件短信并不是必须的它只是一个通知而这种做法让客户端等待没有必要等待的东西并行方式将注册信息写入数据库后发送邮件的同时发送短信以上三个任务完成后返回给客户端并行的方式能提高处理的时间消息队列流量削峰流量削峰一般在秒杀活动中应用广泛场景秒杀活动一般会因为流量过大导致应用挂掉为了解决这个问题一般在应用前端加入消息队列如订单系统在下单的时候就会往数据库写数据但是数据库只能支撑每秒左右的并发写入并发量再高就容易宕机低峰期的时候并发也就多个但是在高峰期时候并发量会突然激增到以上这个时候数据库肯定卡死了传统模式的缺点并发量大的时候所有的请求直接怼到数据库造成数据库连接异常中间件模式消息被保存起来了然后系统就可以按照自己的消费能力来消费比如每秒个数据这样慢慢写入数据库这样就不会卡死数据库了系统慢慢的按照数据库能处理的并发量从消息队列中慢慢拉取消息在生产中这个短暂的高峰期积压是允许的消息队列相关介绍是消息通信的模型实现的大致有两种主流方式是一种高级消息队列协议更准确的说是一种链接协议这是其和的本质差别不从层进行限定而是直接定义网络交换的数据格式即消息服务应用程序接口是一个平台中关于面向消息中间件的用于在两个应用程序之间或分布式系统中发送消息进行异步通信与区别是定义了统一的接口来对消息操作进行统一是通过规定协议来统一数据交互的格式限定了必须使用语言只是协议不规定实现方式因此是跨语言的规定了两种消息模式而的消息模式更加丰富简介即高级消息队列协议是一个网络协议是应用层协议的一个开放标准为面向消息的中间件设计基于此协议的客户端与消息中间件可传递消息并不受客户端中间件不同产品不同的开发语言等条件的限制消费积压中的相关概念接收和分发消息的应用就是出于多租户和安全因素设计的把的基本组件划分到一个虚拟的分组中类似于网络中的概念当多个不同的用户使用同一个提供的服务时可以划分出多个每个用户在自己的创建等和之间的连接如果每一次访问都建立一个在消息量大的时候建立的开销将是巨大的效率也较低是在内部建立的逻辑连接如果应用程序支持多线程通常每个创建单独的进行通讯包含了帮助客户端和识别所以之间是完全隔离的作为轻量级的极大减少了操作系统建立的开销到达的第一站根据分发规则匹配查询表中的分发消息到中去常用的类型有存储消息的容器消息最终被送到这里等待取走和之间的虚拟连接中可以包含信息被保存到中的查询表中用于的分发依据安装及配置下载包下载的包是语言编写所以环境必须要有注环境一定要与版本匹配下载的包安装依赖于所以需要下载下载地址下载的包下载地址根据自身需求及匹配关系下载对应包也可从等网站下载安装安装在安装之前需要先安装否则报错可以采用安装方式我们这里采用安装方式启用管理插件启动查看进程测试关闭防火墙在浏览器中输入地址虚拟机输入默认账号密码用户默认不允许远程连接增加自定义账号添加管理员账号密码分配账号角色设置用户权限用户具有这个中所有资源的配置写读权限修改密码查看用户列表管理界面标签页介绍概览无论生产者还是消费者都需要与建立连接后才可以完成消息的生产和消费在这里可以查看连接情况通道建立连接后会形成通道消息的投递获取依赖通道交换机用来实现消息的路由队列即消息队列消息存放在队列中等待消费消费后被移除队列端口的编程语言客户端连接端口管理界面端口集群的端口卸载管理界面虚拟主机类似于中的他们都是以开头相关概念介绍一个提供统一消息服务的应用层标准高级消息队列协议是应用层协议的一个开放标准为面向消息的中间件设计是协议的的实现概念说明连接一个网络连接比如套接字连接信道多路复用连接中的一条独立的双向数据流通道为会话提供物理传输介质客户端连接或者会话的发起者是非对称的客户端生产和消费消息服务器存储和路由这些消息服务节点消息中间件的服务节点一般情况下可以将一个看作一台服务器端点对话的任意一方一个连接包括两个端点一个是客户端一个是服务器消费者一个从消息队列里请求消息的客户端程序生产者一个向交换机发布消息的客户端应用程序运转流程在入门案例中生产者发送消息生产者创建连接开启一个信道连接到声明队列并设置属性如是否排它是否持久化是否自动删除将路由键空字符串与队列绑定起来发送消息至关闭信道关闭连接消费者接收消息消费者创建连接开启一个信道连接到向请求消费相应队列中的消息设置相应的回调函数等待投递响应队列中的消息消费者接收消息确认自动确认接收到的消息从队列中删除相应已经被确认的消息关闭信道关闭连接入门案列入门案列简单生产者消费者生产者连接密码默认为参数队列名称参数是否定义持久化队列当重启之后还在参数是否独占本次连接是否独占只能有一个消费者监听这个队列当关闭时是否删除队列参数是否在不使用的时候自动删除队列当没有时自动删除参数队列其它参数声明创建队列要发送的信息你好小兔子参数交换机名称如果没有指定则使用默认参数路由简单模式可以传递队列名称参数配置信息参数消息内容已发送消息关闭资源创建连接工厂连接密码默认为创建队列参数队列名称是否持久化当重启之后还在是否独占只能有一个消费者监听这队列当关闭时是否删除队列是否自动删除当没有时自动删除掉参数如果没有一个名字叫的队列则会创建该队列如果有则不会创建接收消息参数队列名称是否自动确认类似咱们发短信发送成功会收到一个确认消息回调对象消费者类似一个监听程序主要是用来监听消息工作模式简单模式概述多个消费端共同消费同一个队列中的消息消费者之间是竞争的关系应用场景对于任务过重或任务较多情况使用工作队列可以提高任务处理的速度代码实现一个生产者一个消费者获取链接创建信道声明队列发消息发送完毕释放链接声明队列实现怎样消费消费发布订阅模式模式说明发布订阅模式每个消费者监听自己的队列生产者将消息发给由交换机将消息转发到绑定此交换机的每个队列每个绑定交换机的队列都将接收到消息代码实现发布订阅模式创建交换机发布订阅模式参数交换机名称交换机类型定向扇形广播发送消息到每一个与之绑定队列通配符的方式参数匹配是否持久化自动删除内部使用一般参数创建队列绑定队列与交换机发送消息日志信息张三调用了方法日志级别释放资源将日志信息打印到控制台将日志信息打印到控制台路由模式模式说明路由模式特点队列与交换机的绑定不能是任意绑定了而是要指定一个路由消息的发送方在向发送消息时也必须指定消息的不再把消息交给每一个绑定的队列而是根据消息的进行判断只有队列的与消息的完全一致才会接收到消息生产者向发送消息发送消息时会指定一个交换机接收生产者的消息然后把消息递交给与完全匹配的队列消费者其所在队列指定了需要为的消息消费者其所在队列指定了需要为的消息代码实现创建交换机发布订阅模式参数交换机名称交换机类型定向扇形广播发送消息到每一个与之绑定队列通配符的方式参数匹配是否持久化自动删除内部使用一般参数创建队列队列绑定交换机指定路由队列绑定日志信息张三调用了方法错误了日志级别将日志信息打印到控制台将日志信息打印到控制台通配符模式模式说明类型与相比都是可以根据把消息路由到不同的队列只不过类型可以让队列在绑定的时候使用通配符一般都是有一个或多个单词组成多个单词之间以分割例如通配符规则匹配零个或多个词匹配不多不少恰好个词举例能够匹配或者只能匹配代码实现创建交换机发布订阅模式参数交换机名称交换机类型定向扇形广播发送消息到每一个与之绑定队列通配符的方式参数匹配是否持久化自动删除内部使用一般参数绑定队列和交换机参数队列名称交换机名称路由键绑定规则如果交换机的类型为设置为系统的名称日志的级别需求所有级别的日志存入数据库所有系统的日志存入数据库队列发送消息工作模式总结工作模式简单模式一个生产者一个消费者不需要设置交换机使用默认的交换机工作队列模式一个生产者多个消费者竞争关系不需要设置交换机使用默认的交换机发布订阅模式需要设置类型为的交换机并且交换机和队列进行绑定当发送消息到交换机后交换机会将消息发送到绑定的队列路由模式需要设置类型为的交换机交换机和队列进行绑定并且指定当发送消息到交换机后交换机会根据将消息发送到对应的队列通配符模式需要设置类型为的交换机交换机和队列进行绑定并且指定通配符方式的当发送消息到交换机后交换机会根据将消息发送到对应的队列整合生产者端加载配置文件定义定义对象用于管理交换机队列简单模式定义持久化队列不存在则自动创建不绑定到交换机则绑定到默认交换机默认交换机类型为名字为路由键为队列的名称广播模式绑定队列与交换机主题通配符模式定义主题交换机中的持久化队列不存在则自动创建定义主题交换机中的持久化队列不存在则自动创建定义主题交换机中的持久化队列不存在则自动创建定义对象操作可以在代码中方便发送消息简单队列消息默认交换机类型为交换机的名称为空路由键为队列的名称路由键与队列同名只发队列的消息消息发送完毕广播模式参数交换机名称参数路由键名广播设置为空参数发送的消息内容发送到交换机的广播消息主题模式参数交换机名称参数路由键名广播设置为空参数发送的消息内容发送到交换机的主题消息通配符交换机类型为匹配路由键的通配符表示一个单词表示多个单词绑定到该交换机的匹配队列能够收到对应消息参数交换机名称参数路由键名参数发送的消息内容发送到交换机的消息发送到交换机的消息消费者端加载配置文件定义定义对象用于管理交换机队列配置简单模式队列监听器队列广播队列主题队列配置监听器简单模式配置消费队列信息广播配置主题通配符队列简单队列监听接收路由名称为路由键为队列名为的消息高级特性消息的可靠性传递发送端在使用的时候作为消息发送方希望杜绝任何消息丢失或者投递失败场景为我们提供了两种方式用来控制消息的投递可靠性模式确认模式退回模式整个消息投递的路径为消息从到则会返回一个消息从投递失败则会返回一个确认模式装配时要配置为加载配置文件定义设置为定义对象用于管理交换机队列绑定队列定义对象操作可以在代码中方便发送消息接收消息成功接收失败接收失败消息做一些处理让消息再次发送成功失败接收失败消息退回模式回退模式当消息发送给后路由到失败时才会执行步骤开启回退模式设置设置处理消息的模式如果消息没有路由到则丢弃消息默认如果消息没有路由到返回给消息发送方设置交换机处理失败消息的模式设置消息对象错误码错误信息交换机路由键执行了处理发送消息失败执行了消息的可靠投递小结设置的开启确认模式使用设置回调函数当消息发送到后回调方法在方法中判断如果为则发送成功如果为则发送失败需要处理设置的开启退回模式使用设置退回函数当消息从路由到失败后如果设置了参数则会将消息退回给并执行回调函数接收端指确认表示消费端收到消息后的确认方式有二种确认方式自动确认默认手动确认其中自动确认是指当消息一旦被接收到则自动确认收到并将相应从的消息缓存中移除但是在实际业务处理中很可能消息接收到业务处理出现异常那么该消息就会丢失如果设置了手动确认方式则需要在业务处理成功后调用手动签收如果出现异常则调用方法让其自动重新发送消息加载配置文件定义定义对象用于管理交换机队列绑定队列监听器设置手动确认设置监听的队列定义对象操作可以在代码中方便发送消息机制设置手动签收让监听器类实现接口如果消息成功处理则调用的签收如果消息处理失败则调用的拒绝签收重新发送给获取消息传递标记接收消息处理业务逻辑处理业务逻辑出现错误手动签收第一个参数表示收到的标签第二个参数如果为表示可以签收所有的消息手动提交拒绝签收第三个参数重回队列设置为则消息重新回到会重新发送该消息给消费端消费限流表示消费端每次从拉去一条消息来消费直到手动确认消费完毕后才会继续拉取下一条消息在中配置属性设置消费端一次拉取多少条消息消费端的必须确认才会继续处理其他消息全称存活时间过期时间当消息到达存活时间后还没有被消费会被自动清除可以对消息设置过期时间也可以对整个队列设置过期时间配置队列过期时间绑定队列消息过期时间过期时间队列统一过期消息单独过期如果设置了消息的过期时间也设置了队列的过期时间它以时间短的为准消息后处理对象设置一些消息的参数信息设置的信息第二个方法消息的过期时间秒之后过期返回该消息消息单独过期死信队列死信队列英文缩写死信交换机当消息成为后可以被重新发送到另一个交换机这个交换机就是什么是死信队列死信顾名思义就是无法被消费的消息字面意思可以这样理解一般来说将消息投递到或者直接到里了从取出消息进行消费但某些时候由于特定的原因导致中的某些消息无法被消费这样的消息如果没有后续的处理就变成了死信有死信自然就有了死信队列消息成为死信的三种情况队列消息数量到达限制比如队列最大只能存储条消息而发了条消息根据先进先出最先发的消息会进入死信队列消费者拒接消费消息并且不把消息重新放入原目标队列原队列存在消息过期设置消息到达超时时间未被消费死信的处理方式死信的产生既然不可避免那么就需要从实际的业务角度和场景出发对这些死信进行后续的处理常见的处理方式丢弃如果不是很重要可以选择丢弃记录死信入库然后做后续的业务分析或处理通过死信队列由负责监听死信的应用程序进行处理队列绑定死信交换机给队列设置参数和过期时间处理代码正常队列绑定死信队列死信交换机名称发送给死信交换机的设置队列的过期时间正常交换机死信队列死信交换机长度限制处理死信队列测试死信队列声明正常的队列和交换机声明死信队列和死信交换机正常队列绑定死信交换机设置两个参数死信交换机名称发送给死信交换机的正常队列绑定死信队列死信交换机名称从新设置消息的发送给死信交换机的设置队列的长度限制正常交换机死信队列死信交换机消息拒收接收转换消息处理业务逻辑处理业务逻辑出现错误手动签收出现异常拒绝接受拒绝签收不重回队列会进入死信队列延迟队列延迟队列存储的对象肯定是对应的延时消息所谓延时消息是指当消息被发送以后并不想让消费者立即拿到消息而是等待指定时间后消费者才拿到这个消息进行消费场景在订单系统中一个用户下单之后通常有分钟的时间进行支付如果分钟之内没有支付成功那么这个订单将进行取消处理这时就可以使用延时队列将订单信息发送到延时队列需求下单后分钟未支付取消订单回滚库存新用户注册成功分钟后发送短信问候很可惜在中并未提供延迟队列功能但是可以使用死信队列组合实现延迟队列的效果集成整合生产者交换机队列队列和交互机绑定关系知道哪个队列知道哪个交换机表示不指定参数消费者监听的队列在消费端绑定在消费端绑定交换机队列路由预约下单队列短信队列更新后发送短信告知消费者端创建交换机绑定交换机绑定队列发送消息交换机路由键消息消息百分百成功投递生产者端首先把消息信息业务数据存储到数据库中紧接着我们再把这个消息记录也存储到一张消息记录表里或者另外一个同源数据库的消息记录表发送消息到节点采用方式发送会有异步的返回结果生产者端接受节点返回的确认消息结果然后进行更新消息记录表里的消息状态比如默认当收到消息确认成功后更新为即可但是在消息确认这个过程中可能由于网络闪断端异常等原因导致回送消息失败或者异常这个时候就需要发送方生产者对消息进行可靠性投递了保障消息不丢失的投递成功有一种极限情况是闪断返回的成功确认消息但是生产端由于网络闪断没收到这个时候重新投递可能会造成消息重复需要消费端去做幂等处理所以我们需要有一个定时任务比如每分钟拉取一下处于中间状态的消息当然这个消息可以设置一个超时时间比如超过分钟也就说明了分钟这个时间窗口内我们的消息没有被确认那么会被定时任务拉取出来接下来我们把中间状态的消息进行重新投递继续发送消息到当然也可能有多种原因导致发送失败我们可以采用设置最大努力尝试次数比如投递了次还是失败那么我们可以将最终状态设置为最后交由人工解决处理此类问题或者把消息转储到失败表中消费幂等性消息幂等性保障乐观锁机制生产者发送消息消费者接收消息消费者需要保证幂等性第一次执行语句第一次执行消费者需要保证幂等性第二次执行语句第二次执行版本已经变更更新不到了保证了幂等性消息确认搭建环境交换机的确认队列的确认默认情况下消息消费者是自动确认消息的如果要手动确认消息则需要修改确认模式为消费者每次从队列获取的消息数量此属性当不设置时为轮询分发设置为为公平分发消息持久化注解中的属性当所有消费客户端连接断开后是否自动删除队列删除不删除注解中的属性当交换器所有的绑定队列都不再使用时是否自动删除交换器更粗粒度不建议删除不删除消息队列协议生产端消息确认配置消息主体交换机路由键重试次数消息类型是否是延迟消息延迟时间消息发送确认只确认消息是否正确到达中消息没有正确到达队列时触发回调如果正确到达队列不执行如果消息没有到则回调如果消息到达则回调到成功则不回调到失败则回调指定指定消息发送成功消息发送失败数据反序列化对象输出消息主体应答码描述消息使用的交换器消息使用的路由键消息主体生产者发送消息应答码描述消息使用的交换器消息使用的路由键生产端消息确认配置百分百发送在发送端封装要发送的信息存入重试的时候获取类重新发送确认消息是否到达交换机消息发送成功消息发送失败数据确实消息是否正确到达队列执行时机到达不执行没到执行消息主体应答码描述消息使用的交换器消息使用的路由键从中获取数据从中获取数据调用重试方法实现重试方法转换获取重试次数判断重试次数已到结束吧更新重试次数重新发送发送消息封装创建实体类封装消息信息设置设置消息设置交换机设置路由存储到发送消息发送消息消息发送生产者发送消息交换机错误生产者发送消息队列错误生产者发送消息接收消息接受消息监听器接受消息成功手动确认延迟队列基于死信实现延迟消息消息的消息的就是消息的存活时间可以对队列和消息分别设置对队列设置就是队列没有消费者连着的保留时间也可以对每一个单独的消息做单独的设置超过了这个时间我们认为这个消息就死了称之为死信如何设置我们创建一个队列在中添加为单位是毫秒那所有压在这个队列的消息在秒后会消失死信交换机一个消息在满足如下条件下会进死信路由记住这里是路由而不是队列一个路由可以对应很多队列一个消息被拒收了并且方法的参数里是也就是说不会被再次放在队列里被其他消费者使用上面的消息的到了消息过期了队列的长度限制满了排在前面的消息会被丢弃或者扔到死信路由上其实就是一种普通的和创建其他没有两样只是在某一个设置的队列中有消息过期了会自动触发消息的转发发送到中去延迟队列的代码实现定义交换机设置延迟时间将队列一通过绑定到交换机上这个队列二就是一个普通队列设置队列二的绑定规则将队列二通过绑定到交换机上基于延迟插件实现延迟消息实现了一个插件来实现延时队列首先我们将刚下载下来的文件上传到所在服务器下载地址切换到插件所在目录执行命令将刚插件拷贝到容器内目录下执行命令进入到容器内部并进入目录执行命令查看插件是否成功在容器内目录下执行命令启用插件命令退出容器内部然后执行命令重启容器第一个参数是创建的的名字第二个参数是是否支持持久化插件方式幂等性处理实现幂等性思路是否接收消息添加标记如果中存在了一定是消费了吗未消费消费设置消息到第一次判断判断是否消费判断消息接收的时间消息的内容是设置消息标识为消息接收的时间消息的内容是设置消息标识为重试机制确认消息是否到达交换机消息发送成功消息发送失败数据确实消息是否正确到达队列执行时机到达不执行没到执行消息主体应答码描述消息使用的交换器消息使用的路由键从中获取数据从中获取数据调用重试方法实现重试方法转换获取重试次数判断重试次数已到结束吧更新重试次数判断是否延迟重新发送延迟消息发送封装发送延迟消息交换机路由键消息单位秒设置消息延迟时间队列延迟交换机绑定队列与交换机超时订单关闭队列延迟交换机绑定队列与交换机设置支付状态设置订单交易号设置创建时间设置过期时间日期加一天设置支付处理状态获取订单明细保存订单信息保存订单详情发送延迟队列如果定时未支付取消订单返回订单发过来的是订单那么你就需要判断一下当前的订单是否已经支付了未支付的情况下关闭订单根据订单查询利用这个接口实现类完成根据订单查询订单信息类底层还是使用的关闭订单',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-07 14:54:07',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-13-21-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623031309-4c1443.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://LisianthusW.github.io/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://chat.qingyunzc.cc" title="卿云AI"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="卿云AI"/><span class="back-menu-item-text">卿云AI</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">卿云</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/?id=6799820199&amp;server=netease"><span> 音乐馆</span></a></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030747-010bf4.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030747-010bf4.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030743-4e58a3.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030743-4e58a3.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Activiti7/" style="font-size: 1.05rem;">Activiti7<sup>4</sup></a><a href="/tags/Android/" style="font-size: 1.05rem;">Android<sup>1</sup></a><a href="/tags/AndroidAPI/" style="font-size: 1.05rem;">AndroidAPI<sup>1</sup></a><a href="/tags/DevOps/" style="font-size: 1.05rem;">DevOps<sup>5</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>1</sup></a><a href="/tags/Docker%E5%AE%89%E8%A3%85/" style="font-size: 1.05rem;">Docker安装<sup>1</sup></a><a href="/tags/EDA/" style="font-size: 1.05rem;">EDA<sup>1</sup></a><a href="/tags/Eureka/" style="font-size: 1.05rem;">Eureka<sup>2</sup></a><a href="/tags/Feign/" style="font-size: 1.05rem;">Feign<sup>1</sup></a><a href="/tags/Galances/" style="font-size: 1.05rem;">Galances<sup>1</sup></a><a href="/tags/Git/" style="font-size: 1.05rem;">Git<sup>12</sup></a><a href="/tags/GitLab/" style="font-size: 1.05rem;">GitLab<sup>10</sup></a><a href="/tags/Github/" style="font-size: 1.05rem;">Github<sup>1</sup></a><a href="/tags/Gitlab/" style="font-size: 1.05rem;">Gitlab<sup>2</sup></a><a href="/tags/Jar/" style="font-size: 1.05rem;">Jar<sup>2</sup></a><a href="/tags/Jenkins/" style="font-size: 1.05rem;">Jenkins<sup>8</sup></a><a href="/tags/LNMP/" style="font-size: 1.05rem;">LNMP<sup>2</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>16</sup></a><a href="/tags/Linux%E5%91%BD%E4%BB%A4/" style="font-size: 1.05rem;">Linux命令<sup>2</sup></a><a href="/tags/MYSQL/" style="font-size: 1.05rem;">MYSQL<sup>4</sup></a><a href="/tags/Nacos/" style="font-size: 1.05rem;">Nacos<sup>5</sup></a><a href="/tags/Nacos%E9%9B%86%E7%BE%A4/" style="font-size: 1.05rem;">Nacos集群<sup>1</sup></a><a href="/tags/SpringCloud/" style="font-size: 1.05rem;">SpringCloud<sup>15</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>3</sup></a><a href="/tags/mysqls/" style="font-size: 1.05rem;">mysqls<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8/" style="font-size: 1.05rem;">事件驱动<sup>1</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7/" style="font-size: 1.05rem;">内存监控<sup>1</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/" style="font-size: 1.05rem;">工作流<sup>4</sup></a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 1.05rem;">微服务<sup>10</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E5%8F%AF%E7%94%A8/" style="font-size: 1.05rem;">数据库高可用<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>10</sup></a><a href="/tags/%E6%B8%97%E9%80%8F%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">渗透系统<sup>2</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>8</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" style="font-size: 1.05rem;">系统架构<sup>27</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/" style="font-size: 1.05rem;">自动化运维<sup>8</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8F%91%E5%B8%83%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">自动发布系统<sup>4</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">软件系统<sup>3</sup></a><a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 1.05rem;">运维<sup>7</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B%E6%A3%80%E6%B5%8B%E4%B8%8E%E6%8E%A7%E5%88%B6/" style="font-size: 1.05rem;">进程检测与控制<sup>1</sup></a><a href="/tags/%E9%80%86%E5%90%91%E7%88%AC%E8%99%AB/" style="font-size: 1.05rem;">逆向爬虫<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">14</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%85%A8%E6%A0%88/" itemprop="url">全栈</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>系统架构</span></a><a class="article-meta__tags" href="/tags/RabbitMQ/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>RabbitMQ</span></a><a class="article-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>消息队列</span></a></span></div></div><h1 class="post-title" itemprop="name headline">RabbitMQ[复盘]</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-09T03:34:21.000Z" title="发表于 2024-08-09 11:34:21">2024-08-09</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-05-07T06:54:07.247Z" title="更新于 2025-05-07 14:54:07">2025-05-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为北京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>北京</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/17/17-54-55-image-20210717162752376-fb7887.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://lisianthusw.github.io/2024/08/09/RabbitMQ%E7%9F%A5%E8%AF%86%E5%BA%93/"><header><a class="post-meta-categories" href="/categories/%E5%85%A8%E6%A0%88/" itemprop="url">全栈</a><a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" tabindex="-1" itemprop="url">系统架构</a><a href="/tags/RabbitMQ/" tabindex="-1" itemprop="url">RabbitMQ</a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" tabindex="-1" itemprop="url">消息队列</a><h1 id="CrawlerTitle" itemprop="name headline">RabbitMQ[复盘]</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Flaw</span><time itemprop="dateCreated datePublished" datetime="2024-08-09T03:34:21.000Z" title="发表于 2024-08-09 11:34:21">2024-08-09</time><time itemprop="dateCreated datePublished" datetime="2025-05-07T06:54:07.247Z" title="更新于 2025-05-07 14:54:07">2025-05-07</time></header><h2 id="1-1概述"><a href="#1-1概述" class="headerlink" title="1.1概述"></a>1.1概述</h2><p>在项目中，可将一些无需即时返回且耗时的操作提取出来，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了**系统的吞吐量。</p>
<h3 id="1-1-1-QPS概念"><a href="#1-1-1-QPS概念" class="headerlink" title="1.1.1 QPS概念"></a>1.1.1 QPS概念</h3><p>QPS即每秒查询率，是对一个特定的查询服务器<strong>在规定时间内所处理流量多少</strong>的衡量标准。<br>每秒查询率：<br>因特网上，经常用每秒查询率来衡量域名系统服务器的机器的性能，即为QPS。<br>或者理解：每秒的响应请求数，也即是最大吞吐能力。</p>
<p>计算关系：<br>QPS &#x3D; 并发量 &#x2F; 平均响应时间<br>并发量 &#x3D; QPS * 平均响应时间<br>原理：每天80%的访问集中在20%的时间里，这20%时间叫做峰值时间<br>公式：( 总PV数 * 80% ) &#x2F; ( 每天秒数 * 20% ) &#x3D; 峰值时间每秒请求数(QPS) 。<br>机器：峰值时间每秒QPS &#x2F; 单台机器的QPS &#x3D; 需要的机器 。</p>
<hr>
<h3 id="1-1-2PV-UV-PR"><a href="#1-1-2PV-UV-PR" class="headerlink" title="1.1.2PV UV PR"></a>1.1.2PV UV PR</h3><p>① 什么是pv<br>**PV(page view)<strong>，即页面浏览量，或点击量；通常是衡量一个网络新闻频道或网站甚至一条网络新闻的主要指标。<br>对pv的解释是，一个访问者在24小时(0点到24点)内到底看了你网站几个页面。这里需要强调：同一个人浏览你网站同一个页面，不重复计算pv量，点100次也算1次。说白了，pv就是一个访问者打开了你的几个页面。<br>PV之于网站，就像收视率之于电视，从某种程度上已成为投资者衡量商业网站表现的最重要尺度。<br>pv的计算：当一个访问者访问的时候，记录他所访问的页面和对应的IP，然后确定这个IP今天访问了这个页面没有。如果你的网站到了23点，单纯IP有60万条的话，每个访问者平均访问了3个页面，那么pv表的记录就要有180万条。<br>② 什么是uv<br>**     uv(unique visitor)<strong>，指访问某个站点或点击某条新闻的不同IP地址的人数。<br>在同一天内，uv只记录第一次进入网站的具有独立IP的访问者，在同一天内再次访问该网站则不计数。独立IP访问者提供了一定时间内不同观众数量的统计指标，而没有反应出网站的全面活动。<br>③ 什么是pr值<br>      PR值，即</strong>PageRank</strong>，网页的级别技术，用来标识网页的等级&#x2F;重要性。级别从1到10级，10级为满分。PR值越高说明该网页越受欢迎（越重要）。<br>例如：一个PR值为1的网站表明这个网站不太具有流行度，而PR值为7到10则表明这个网站非常受欢迎（或者说极其重要）。</p>
<hr>
<h2 id="1-2-消息队列应用场景"><a href="#1-2-消息队列应用场景" class="headerlink" title="1.2.消息队列应用场景"></a><strong>1.2.消息队列应用场景</strong></h2><h3 id="1-2-1应用解耦"><a href="#1-2-1应用解耦" class="headerlink" title="1.2.1应用解耦"></a>1.2.1应用解耦</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-38-56-1678180771096-4a4df85e-5bf2-4dab-b8e7-138eec1f0f3f-56180b.png" alt="image.png"><br><strong>传统模式的缺点：</strong></p>
<ul>
<li>系统间耦合性太强，如上图所示，系统A在代码中直接调用系统B和系统C的代码，如果将来D系统接入，系统A还需要修改代码，过于麻烦！</li>
</ul>
<p><strong>中间件模式：</strong></p>
<ul>
<li><p>将消息写入消息队列，需要消息的系统自己从消息队列中订阅，从而系统A不需要做任何修改。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-41-36-1678180850055-bb0ba918-f62c-4f1b-9b87-8f5ca4e57b5f-2d918b.png" alt="image.png"></p>
</li>
</ul>
<hr>
<h3 id="1-2-2-异步处理"><a href="#1-2-2-异步处理" class="headerlink" title="1.2.2.异步处理"></a><strong>1.2.2.异步处理</strong></h3><p>用户注册后，需要发注册邮件和注册短信，传统的做法有两种</p>
<pre><code>  - 串行的方式
  - 并行的方式
</code></pre>
<p><strong>(1) 串行方式：</strong><br>  将注册信息写入数据库后，发送注册邮件，再发送注册短信，以上三个任务全部完成后才返回给客户端。这有一个问题是，邮件，短信并不是必须的，它只是一个通知，而这种做法让客户端等待没有必要等待的东西。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-38-57-1678181049068-a56c8c4a-d7de-4a3e-8c2e-06d7981d6763-607687.png" alt="image.png"><br><strong>(2) 并行方式：</strong><br>将注册信息写入数据库后，发送邮件的同时，发送短信，以上三个任务完成后，返回给客户端，并行的方式能提高处理的时间。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-38-59-1678181088095-92a3896c-d53f-400b-be99-33ff96cff7f8-e806ae.png" alt="image.png"><br><strong>(3)消息队列：</strong><br>       <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-00-1678181144653-9a12344e-0aa6-41a4-a67d-7fe2b14a126f-c3e8e4.png" alt="image.png"></p>
<h3 id="1-2-3-流量削峰"><a href="#1-2-3-流量削峰" class="headerlink" title="1.2.3.流量削峰"></a><strong>1.2.3.流量削峰</strong></h3><p>流量削峰一般在秒杀活动中应用广泛<br>**      场景：** 秒杀活动，一般会因为流量过大，导致应用挂掉，为了解决这个问题，一般在应用前端加入消息队列。<br>如订单系统，在下单的时候就会往数据库写数据。但是数据库只能支撑每秒1000左右的并发写入，并发量再高就容易宕机。低峰期的时候并发也就100多个，但是在高峰期时候，并发量会突然激增到5000以上，这个时候数据库肯定卡死了。<br>       <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-02-1678181327836-75707493-aff2-47ba-b76a-968e6fa3ca1f-894458.png" alt="image.png"><br><strong>传统模式的缺点：</strong></p>
<ul>
<li>并发量大的时候，所有的请求直接怼到数据库，造成数据库连接异常</li>
</ul>
<p><strong>中间件模式：</strong></p>
<ul>
<li>消息被MQ保存起来了，然后系统就可以按照自己的消费能力来消费，比如每秒1000个数据，这样慢慢写入数据库，这样就不会卡死数据库了。</li>
<li>系统A慢慢的按照数据库能处理的并发量，从消息队列中慢慢拉取消息。在生产中，这个短暂的高峰期积压是允许的。</li>
</ul>
<hr>
<h1 id="2-消息队列相关介绍"><a href="#2-消息队列相关介绍" class="headerlink" title="2.消息队列相关介绍"></a>2.消息队列相关介绍</h1><p>  MQ是消息通信的模型；实现MQ的大致有两种主流方式：AMQP、JMS。</p>
<h3 id="2-2-1-AMQP"><a href="#2-2-1-AMQP" class="headerlink" title="2.2.1. AMQP"></a><strong>2.2.1. AMQP</strong></h3><p>AMQP是一种<strong>高级消息队列协议（Advanced Message Queuing Protocol）</strong>，更准确的说是一种binary wire-level protocol（<strong>链接协议</strong>）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式。</p>
<h3 id="2-2-2-JMS"><a href="#2-2-2-JMS" class="headerlink" title="2.2.2. JMS"></a><strong>2.2.2. JMS</strong></h3><p>JMS即<strong>Java消息服务（JavaMessage Service）</strong>应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。</p>
<h3 id="2-2-3-AMQP-与-JMS-区别"><a href="#2-2-3-AMQP-与-JMS-区别" class="headerlink" title="2.2.3. AMQP 与 JMS 区别"></a><strong>2.2.3. AMQP 与 JMS 区别</strong></h3><ul>
<li>JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式</li>
<li>JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</li>
<li>JMS规定了两种消息模式；而AMQP的消息模式更加丰富</li>
</ul>
<h3 id="2-2-4-RabbitMQ简介"><a href="#2-2-4-RabbitMQ简介" class="headerlink" title="2.2.4 RabbitMQ简介"></a><strong>2.2.4 RabbitMQ简介</strong></h3><p>AMQP，即 Advanced Message Queuing Protocol（高级消息队列协议），是一个网络协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端&#x2F;中间件不同产品，不同的开发语言等条件的限制。<br>消费积压<br>    <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-04-1678200785647-0555aa5a-b005-43ed-b25a-c4e45906dc4a-ef3780.png" alt="image.png"><br>     <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-05-1678200427565-d6febd41-c58c-49c4-9d29-a1efc130ceb5-c22323.png" alt="image.png"></p>
<h3 id="2-2-5-RabbitMQ-中的相关概念"><a href="#2-2-5-RabbitMQ-中的相关概念" class="headerlink" title="2.2.5 RabbitMQ 中的相关概念"></a><strong>2.2.5 RabbitMQ 中的相关概念</strong></h3><p>Broker：接收和分发消息的应用，RabbitMQ Server就是 Message Broker<br>Virtual host:出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个vhost，每个用户在自己的 vhost 创建 exchange／queue 等<br>Connection：publisher／consumer 和 broker 之间的 TCP 连接<br>Channel：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个thread创建单独的 channel 进行通讯，AMQP method 包含了channel id 帮助客户端和message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销<br>Exchange：message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到queue 中去。常用的类型有：<strong>direct (point-to-point)<strong>，</strong>topic (publish-subscribe)</strong> and <strong>fanout (multicast)</strong><br>Queue：存储消息的容器，消息最终被送到这里，等待 consumer 取走<br>Binding：exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key。Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据</p>
<hr>
<h1 id="3-RabbitMQ安装及配置"><a href="#3-RabbitMQ安装及配置" class="headerlink" title="3.RabbitMQ安装及配置"></a>3.RabbitMQ安装及配置</h1><h2 id="3-1下载包"><a href="#3-1下载包" class="headerlink" title="3.1下载包"></a>3.1下载包</h2><p><strong>1.下载Erlang的rpm包</strong><br>RabbitMQ是Erlang语言编写，所以Erang环境必须要有，注：Erlang环境一定要与RabbitMQ版本匹配：<br><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/which-erlang.html">https://www.rabbitmq.com/which-erlang.html</a><br><strong>2.下载socat的rpm包</strong><br>rabbitmq安装依赖于socat，所以需要下载socat。<br>socat下载地址：<a target="_blank" rel="noopener" href="http://repo.iotti.biz/CentOS/7/x86_64/socat-1.7.3.2-5.el7.lux.x86_64.rpm">http://repo.iotti.biz/CentOS/7/x86_64/socat-1.7.3.2-5.el7.lux.x86_64.rpm</a><br><strong>3.下载RabbitMQ的rpm包</strong><br>RabbitMQ下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html%EF%BC%88%E6%A0%B9%E6%8D%AE%E8%87%AA%E8%BA%AB%E9%9C%80%E6%B1%82%E5%8F%8A%E5%8C%B9%E9%85%8D%E5%85%B3%E7%B3%BB%EF%BC%8C%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94rpm%E5%8C%85%EF%BC%89rabbitmq-server-3.8.1-1.el7.noarch.rpm">https://www.rabbitmq.com/download.html（根据自身需求及匹配关系，下载对应rpm包）rabbitmq-server-3.8.1-1.el7.noarch.rpm</a><br>也可从github等网站下载。<a target="_blank" rel="noopener" href="https://hub.fastgit.org/rabbitmq/rabbitmq-server/releases/">https://hub.fastgit.org/rabbitmq/rabbitmq-server/releases/</a> </p>
<hr>
<h2 id="3-2安装"><a href="#3-2安装" class="headerlink" title="3.2安装"></a>3.2安装</h2><h3 id="1-安装Erlang、Socat、RabbitMQ"><a href="#1-安装Erlang、Socat、RabbitMQ" class="headerlink" title="1.安装Erlang、Socat、RabbitMQ"></a>1.安装Erlang、Socat、RabbitMQ</h3><p>**①rpm -ivh erlang-21.3.8.9-1.el7.x86_64.rpm **<br><strong>②rpm -ivh socat-1.7.3.2-1.el6.lux.x86_64.rpm</strong><br>在安装rabbitmq之前需要先安装socat，否则，报错。可以采用yum安装方式：yum install socat，我们这里采用rpm安装方式<br>**③rpm -ivh rabbitmq-server-3.8.1-1.el7.noarch.rpm **<br>&#x2F;usr&#x2F;lib&#x2F;rabbitmq&#x2F;bin&#x2F; </p>
<h3 id="2-启用管理插件"><a href="#2-启用管理插件" class="headerlink" title="2.启用管理插件"></a>2.启用管理插件</h3><p>rabbitmq-plugins enable rabbitmq_management</p>
<h3 id="3-启动RabbitMQ"><a href="#3-启动RabbitMQ" class="headerlink" title="3.启动RabbitMQ"></a>3.启动RabbitMQ</h3><p>systemctl start rabbitmq-server.service<br>systemctl status rabbitmq-server.service<br>systemctl restart rabbitmq-server.service<br>systemctl stop rabbitmq-server.service </p>
<h3 id="4-查看进程"><a href="#4-查看进程" class="headerlink" title="4.查看进程"></a>4.查看进程</h3><p>ps -ef | grep rabbitmq</p>
<h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5.测试"></a>5.测试</h3><pre><code>  - 关闭防火墙：systemctl stop firewalld.service
  -  在web浏览器中输入地址：http://虚拟机ip:15672/
  - 输入默认账号密码：guest ： guest，guest用户默认不允许远程连接。
</code></pre>
<ul>
<li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-08-1678262708688-21ccc2ee-a5d0-43b1-bd0a-9ec7d39d501a-f50396.png" alt="image.png"></li>
</ul>
<hr>
<h3 id="6-增加自定义账号"><a href="#6-增加自定义账号" class="headerlink" title="6.增加自定义账号"></a>6.增加自定义账号</h3><pre><code>  1. 添加管理员账号密码：rabbitmqctl add_user admin admin
  2. 分配账号角色：rabbitmqctl set_user_tags admin administrator
  3. 设置用户权限 ：set_permissions [-p &lt;vhostpath&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;read&gt; 

rabbitmqctl set_permissions -p &quot;/&quot; admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot; 

  4. 用户user_admin具有/vhost1这个virtual host中所有资源的配置、写、读权限
  5. 修改密码：rabbitmqctl change_password admin 123456
  6. 查看用户列表：rabbitmqctl list_users  
</code></pre>
<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-10-1678263019265-c88a13d6-73ff-409b-9428-9a0c30791b21-7fa3a9.png" alt="image.png"></p>
<hr>
<p><strong>管理界面标签页介绍</strong><br>overview：概览<br>connections：无论生产者还是消费者，都需要与RabbitMQ建立连接后才可以完成消息的生产和消费，在这里可以查看连接情况<br>channels：通道，建立连接后，会形成通道，消息的投递获取依赖通道。<br>Exchanges：交换机，用来实现消息的路由<br>Queues：队列，即消息队列，消息存放在队列中，等待消费，消费后被移除队列。<br>** 端口：**<br>5672：rabbitMq的编程语言客户端连接端口<br>15672：rabbitMq管理界面端口<br>25672：rabbitMq集群的端口</p>
<hr>
<h3 id="7-卸载"><a href="#7-卸载" class="headerlink" title="7.卸载"></a>7.卸载</h3><ul>
<li>rpm -qa | grep rabbitmq</li>
<li>rpm -e rabbitmq-server</li>
</ul>
<hr>
<h2 id="3-3管理界面"><a href="#3-3管理界面" class="headerlink" title="3.3管理界面"></a>3.3管理界面</h2><p>虚拟主机：类似于mysql中的database。他们都是以“&#x2F;”开头<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-11-1678264155513-37f78c0d-0e72-45af-b1eb-8a94027207fb-8bb590.png" alt="image.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-41-43-1678264177710-7787e7da-f600-479a-b321-792bb8edecb2-934787.png" alt="image.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-15-1678264183478-3b672b5b-9fe9-4c50-bf5c-dc9420e3a934-bbe147.png" alt="image.png"></p>
<hr>
<h1 id="4-AMQP"><a href="#4-AMQP" class="headerlink" title="4.AMQP"></a>4.AMQP</h1><h2 id="4-1-相关概念介绍"><a href="#4-1-相关概念介绍" class="headerlink" title="4.1. 相关概念介绍"></a><strong>4.1. 相关概念介绍</strong></h2><p>AMQP 一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。<br>RabbitMQ是AMQP协议的Erlang的实现。</p>
<table>
<thead>
<tr>
<th><strong>概念</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>连接Connection</td>
<td>一个网络连接，比如TCP&#x2F;IP套接字连接。</td>
</tr>
<tr>
<td>信道Channel</td>
<td>多路复用连接中的一条独立的双向数据流通道。为会话提供物理传输介质。</td>
</tr>
<tr>
<td>客户端Client</td>
<td>AMQP连接或者会话的发起者。AMQP是非对称的，客户端生产和消费消息，服务器存储和路由这些消息。</td>
</tr>
<tr>
<td>服务节点Broker</td>
<td>消息中间件的服务节点；一般情况下可以将一个RabbitMQ Broker看作一台RabbitMQ 服务器。</td>
</tr>
<tr>
<td>端点</td>
<td>AMQP对话的任意一方。一个AMQP连接包括两个端点（一个是客户端，一个是服务器）。</td>
</tr>
<tr>
<td>消费者Consumer</td>
<td>一个从消息队列里请求消息的客户端程序。</td>
</tr>
<tr>
<td>生产者Producer</td>
<td>一个向交换机发布消息的客户端应用程序。</td>
</tr>
</tbody></table>
<hr>
<h2 id="4-2-RabbitMQ运转流程"><a href="#4-2-RabbitMQ运转流程" class="headerlink" title="4.2. RabbitMQ运转流程"></a><strong>4.2. RabbitMQ运转流程</strong></h2><p>在入门案例中：<br>· 生产者发送消息</p>
<ol>
<li>生产者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker；</li>
<li>声明队列并设置属性；如是否排它，是否持久化，是否自动删除；</li>
<li>将路由键（空字符串）与队列绑定起来；</li>
<li>发送消息至RabbitMQ Broker；</li>
<li>关闭信道；</li>
<li>关闭连接；<br>· 消费者接收消息</li>
<li>消费者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker</li>
<li>向Broker 请求消费相应队列中的消息，设置相应的回调函数；</li>
<li>等待Broker投递响应队列中的消息，消费者接收消息；</li>
<li>确认（ack，自动确认）接收到的消息；</li>
<li>RabbitMQ从队列中删除相应已经被确认的消息；</li>
<li>关闭信道；</li>
<li>关闭连接；</li>
</ol>
<hr>
<h1 id="5-RabbitMQ入门案列"><a href="#5-RabbitMQ入门案列" class="headerlink" title="5.RabbitMQ入门案列"></a>5.RabbitMQ入门案列</h1><h2 id="5-1入门案列"><a href="#5-1入门案列" class="headerlink" title="5.1入门案列"></a>5.1入门案列</h2><p><strong>简单生产者消费者</strong><br>       <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-17-1678269358932-83a2c7f3-0977-42fc-a3bc-ea46210b1498-3fb23f.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;amqp-client&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">5.6</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;<span class="number">3.8</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;<span class="number">1.8</span>&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;<span class="number">1.8</span>&lt;/target&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.simple;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *1.生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;192.168.10.101&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line"></span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="comment">//连接密码；默认为guest</span></span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * queue      参数1：队列名称</span></span><br><span class="line"><span class="comment">         * durable    参数2：是否定义持久化队列,当mq重启之后,还在</span></span><br><span class="line"><span class="comment">         * exclusive  参数3：是否独占本次连接</span></span><br><span class="line"><span class="comment">         *            ① 是否独占,只能有一个消费者监听这个队列</span></span><br><span class="line"><span class="comment">         *            ② 当connection关闭时,是否删除队列</span></span><br><span class="line"><span class="comment">         * autoDelete 参数4：是否在不使用的时候自动删除队列,当没有consumer时,自动删除</span></span><br><span class="line"><span class="comment">         * arguments  参数5：队列其它参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明（创建）队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;simple_queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 要发送的信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;你好；小兔子！&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：交换机名称,如果没有指定则使用默认Default Exchage</span></span><br><span class="line"><span class="comment">         * 参数2：路由key,简单模式可以传递队列名称</span></span><br><span class="line"><span class="comment">         * 参数3：配置信息</span></span><br><span class="line"><span class="comment">         * 参数4：消息内容</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,<span class="string">&quot;simple_queue&quot;</span>,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">&quot;已发送消息：&quot;</span> + message);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//1.创建连接工厂</span></span><br><span class="line">        ConnectionFactory  connectionFactory= <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;192.168.10.101&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line"></span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="comment">//连接密码；默认为guest</span></span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 创建队列Queue</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">            1. queue：队列名称</span></span><br><span class="line"><span class="comment">            2. durable：是否持久化,当mq重启之后,还在</span></span><br><span class="line"><span class="comment">            3. exclusive：</span></span><br><span class="line"><span class="comment">                * 是否独占。只能有一个消费者监听这队列</span></span><br><span class="line"><span class="comment">                * 当Connection关闭时,是否删除队列</span></span><br><span class="line"><span class="comment">            4. autoDelete：是否自动删除。当没有Consumer时,自动删除掉</span></span><br><span class="line"><span class="comment">            5. arguments：参数。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//如果没有一个名字叫simple_queue的队列,则会创建该队列,如果有则不会创建</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;simple_queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumerTag：&quot;</span>+consumerTag);</span><br><span class="line">                System.out.println(<span class="string">&quot;Exchange：&quot;</span>+envelope.getExchange());</span><br><span class="line">                System.out.println(<span class="string">&quot;RoutingKey：&quot;</span>+envelope.getRoutingKey());</span><br><span class="line">                System.out.println(<span class="string">&quot;properties：&quot;</span>+properties);</span><br><span class="line">                System.out.println(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">        1. queue：队列名称</span></span><br><span class="line"><span class="comment">        2. autoAck：是否自动确认 ,类似咱们发短信,发送成功会收到一个确认消息</span></span><br><span class="line"><span class="comment">        3. callback：回调对象</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 消费者类似一个监听程序,主要是用来监听消息</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;simple_queue&quot;</span>,<span class="literal">true</span>,consumer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-27-1678269335203-b7f54bf9-f2a4-4d98-944e-32e2b3d49031-1f9f59.png" alt="image.png"></p>
<hr>
<h1 id="6-RabbitMQ工作模式"><a href="#6-RabbitMQ工作模式" class="headerlink" title="6.RabbitMQ工作模式"></a>6.RabbitMQ工作模式</h1><h2 id="6-1-简单模式"><a href="#6-1-简单模式" class="headerlink" title="6.1 简单模式"></a>6.1 简单模式</h2><h3 id="6-1-1概述"><a href="#6-1-1概述" class="headerlink" title="6.1.1概述"></a>6.1.1概述</h3><p>​     <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-35-1678325226042-db307fe8-e882-477d-84cb-d332ba7f6810-3da9c8.png" alt="image.png"></p>
<ul>
<li>多个消费端共同消费同一个队列中的消息。</li>
<li>消费者之间是竞争的关系</li>
<li><strong>应用场景</strong>：对于任务过重或任务较多情况使用工作队列可以<strong>提高任务处理的速度</strong></li>
</ul>
<hr>
<h3 id="6-1-2-代码实现"><a href="#6-1-2-代码实现" class="headerlink" title="6.1.2 代码实现"></a>6.1.2 代码实现</h3><p>**   一个生产者，一个消费者**</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">ConnectionRabbitMQUtil</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="title class_">Connection</span> <span class="title function_">getConnection</span>() throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">ConnectionFactory</span> factory = <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.<span class="title function_">setHost</span>(<span class="string">&quot;192.168.10.101&quot;</span>);</span><br><span class="line">        factory.<span class="title function_">setPort</span>(<span class="number">5672</span>);</span><br><span class="line">        factory.<span class="title function_">setUsername</span>(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.<span class="title function_">setPassword</span>(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.<span class="title function_">setVirtualHost</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取链接</span></span><br><span class="line">        <span class="title class_">Connection</span> connection = factory.<span class="title function_">newConnection</span>();</span><br><span class="line">        <span class="keyword">return</span>  connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title function_">release</span>(<span class="params">Connection connection,Channel channel</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel.<span class="title function_">close</span>();</span><br><span class="line">            connection.<span class="title function_">close</span>();</span><br><span class="line">        &#125;  <span class="keyword">catch</span> (<span class="title class_">TimeoutException</span> | <span class="title class_">IOException</span> e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">simple</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">utils</span>.<span class="property">ConnectionRabbitMQUtil</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">Channel</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">Connection</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">concurrent</span>.<span class="property">TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Producer_01</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="comment">//1.创建信道</span></span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.声明队列</span></span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(<span class="string">&quot;worker_queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.发消息</span></span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>;i&lt;<span class="number">100000000</span>; i++) &#123;</span><br><span class="line">            <span class="title class_">String</span> body = i+<span class="string">&quot;hello rabbitmq~~~&quot;</span>;</span><br><span class="line">            channel.<span class="title function_">basicPublish</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;worker_queue&quot;</span>,<span class="literal">null</span>,body.<span class="title function_">getBytes</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;发送完毕.......&quot;</span>);</span><br><span class="line">        <span class="comment">//4.释放链接</span></span><br><span class="line">        <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">release</span>(connection,channel);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">simple</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">utils</span>.<span class="property">ConnectionRabbitMQUtil</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.*;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">concurrent</span>.<span class="property">TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Consumer_01</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.声明队列</span></span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(<span class="string">&quot;worker_queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.实现怎样消费</span></span><br><span class="line">        <span class="title class_">DefaultConsumer</span> consumer = <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="keyword">void</span> <span class="title function_">handleDelivery</span>(<span class="title class_">String</span> consumerTag, <span class="title class_">Envelope</span> envelope, <span class="variable constant_">AMQP</span>.<span class="property">BasicProperties</span> properties, byte[] body) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.消费</span></span><br><span class="line">        channel.<span class="title function_">basicConsume</span>(<span class="string">&quot;worker_queue&quot;</span>,<span class="literal">true</span>,consumer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​      <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-49-1678325462350-0d48a5ec-000c-468b-b936-512014977f2e-49d6d2.png" alt="image.png"></p>
<hr>
<h2 id="6-2-发布订阅模式"><a href="#6-2-发布订阅模式" class="headerlink" title="6.2 发布订阅模式"></a>6.2 发布订阅模式</h2><h3 id="6-2-1模式说明"><a href="#6-2-1模式说明" class="headerlink" title="6.2.1模式说明"></a>6.2.1模式说明</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-46-1678325585124-713777a4-f805-4f9a-bf57-514c14805a6c-9b9b9b.png" alt="image.png"><br>发布订阅模式：<br>    1、每个消费者监听自己的队列。<br>    2、生产者将消息发给broker，<strong>由交换机将消息转发到绑定此交换机的每个队列</strong>，每个绑定交换机的队列都将接收到消息</p>
<hr>
<h3 id="6-2-2-代码实现"><a href="#6-2-2-代码实现" class="headerlink" title="6.2.2 代码实现"></a>6.2.2 代码实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 发布订阅模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.创建交换机</span></span><br><span class="line">        <span class="title class_">String</span> exchangeName = <span class="string">&quot;test_fanout&quot;</span>;</span><br><span class="line">        <span class="comment">//发布订阅模式</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">        1. exchange：交换机名称</span></span><br><span class="line"><span class="comment">        2. type：交换机类型</span></span><br><span class="line"><span class="comment">            DIRECT(&quot;direct&quot;),：定向</span></span><br><span class="line"><span class="comment">            FANOUT(&quot;fanout&quot;),：扇形（广播）,发送消息到每一个与之绑定队列。</span></span><br><span class="line"><span class="comment">            TOPIC(&quot;topic&quot;),通配符的方式</span></span><br><span class="line"><span class="comment">            HEADERS(&quot;headers&quot;);参数匹配</span></span><br><span class="line"><span class="comment">        3. durable：是否持久化</span></span><br><span class="line"><span class="comment">        4. autoDelete：自动删除</span></span><br><span class="line"><span class="comment">        5. internal：内部使用。 一般false</span></span><br><span class="line"><span class="comment">        6. arguments：参数</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        channel.<span class="title function_">exchangeDeclare</span>(exchangeName, <span class="title class_">BuiltinExchangeType</span>.<span class="property">FANOUT</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 创建队列</span></span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">        <span class="title class_">String</span> queue2Name = <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.绑定队列与交换机</span></span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue1Name,exchangeName,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue2Name,exchangeName,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.发送消息</span></span><br><span class="line">        <span class="title class_">String</span> body = <span class="string">&quot;日志信息：张三调用了findAll方法...日志级别：info...&quot;</span>;</span><br><span class="line">        channel.<span class="title function_">basicPublish</span>(exchangeName,<span class="string">&quot;&quot;</span>,<span class="literal">null</span>,body.<span class="title function_">getBytes</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 释放资源</span></span><br><span class="line">        channel.<span class="title function_">close</span>();</span><br><span class="line">        connection.<span class="title function_">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">Customer_1</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">        <span class="title class_">Consumer</span> consumer = <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="keyword">void</span> <span class="title function_">handleDelivery</span>(<span class="title class_">String</span> consumerTag, <span class="title class_">Envelope</span> envelope, <span class="variable constant_">AMQP</span>.<span class="property">BasicProperties</span> properties, byte[] body) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;将日志信息打印到控制台.....&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.<span class="title function_">basicConsume</span>(queue1Name,<span class="literal">true</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">Customer_2</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line">        <span class="title class_">Consumer</span> consumer = <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="keyword">void</span> <span class="title function_">handleDelivery</span>(<span class="title class_">String</span> consumerTag, <span class="title class_">Envelope</span> envelope, <span class="variable constant_">AMQP</span>.<span class="property">BasicProperties</span> properties, byte[] body) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;将日志信息打印到控制台.....&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.<span class="title function_">basicConsume</span>(queue1Name,<span class="literal">true</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-3Routing路由模式"><a href="#6-3Routing路由模式" class="headerlink" title="6.3Routing路由模式"></a>6.3Routing路由模式</h2><h3 id="6-3-1模式说明"><a href="#6-3-1模式说明" class="headerlink" title="6.3.1模式说明"></a>6.3.1模式说明</h3><p>路由模式特点：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个RoutingKey（路由key）</li>
<li>消息的发送方在向 Exchange发送消息时，也必须指定消息的 RoutingKey。</li>
<li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的Routing Key进行判断，只有队列的Routingkey与消息的 Routing key完全一致，才会接收到消息</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-39-55-1678333728822-4c0a9f79-14b8-423a-9183-75f4bf1cbd38-abd9df.png" alt="image.png"></p>
<p>· P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。<br>· X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与routing key完全匹配的队列<br>· C1：消费者，其所在队列指定了需要routing key 为 error 的消息<br>· C2：消费者，其所在队列指定了需要routing key 为 info、error、warning 的消息</p>
<hr>
<h3 id="6-3-2代码实现"><a href="#6-3-2代码实现" class="headerlink" title="6.3.2代码实现"></a>6.3.2代码实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">direct</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">utils</span>.<span class="property">ConnectionRabbitMQUtil</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">BuiltinExchangeType</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">Channel</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">Connection</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">concurrent</span>.<span class="property">TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.创建交换机</span></span><br><span class="line">                     </span><br><span class="line">        <span class="comment">//发布订阅模式</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">        1. exchange：交换机名称</span></span><br><span class="line"><span class="comment">        2. type：交换机类型</span></span><br><span class="line"><span class="comment">            DIRECT(&quot;direct&quot;),：定向</span></span><br><span class="line"><span class="comment">            FANOUT(&quot;fanout&quot;),：扇形（广播）,发送消息到每一个与之绑定队列。</span></span><br><span class="line"><span class="comment">            TOPIC(&quot;topic&quot;),通配符的方式</span></span><br><span class="line"><span class="comment">            HEADERS(&quot;headers&quot;);参数匹配</span></span><br><span class="line"><span class="comment">        3. durable：是否持久化</span></span><br><span class="line"><span class="comment">        4. autoDelete：自动删除</span></span><br><span class="line"><span class="comment">        5. internal：内部使用。 一般false</span></span><br><span class="line"><span class="comment">        6. arguments：参数</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        channel.<span class="title function_">exchangeDeclare</span>(exchangeName, <span class="title class_">BuiltinExchangeType</span>.<span class="property">DIRECT</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 创建队列</span></span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">        <span class="title class_">String</span> queue2Name = <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.队列绑定交换机</span></span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue1Name,exchangeName,<span class="string">&quot;error&quot;</span>); <span class="comment">//指定路由key</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 队列2绑定info error warning</span></span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue2Name,exchangeName,<span class="string">&quot;info&quot;</span>);</span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue2Name,exchangeName,<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue2Name,exchangeName,<span class="string">&quot;warning&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">String</span> message = <span class="string">&quot;日志信息：张三调用了delete方法.错误了,日志级别warning&quot;</span>;</span><br><span class="line"></span><br><span class="line">        channel.<span class="title function_">basicPublish</span>(exchangeName,<span class="string">&quot;info&quot;</span>,<span class="literal">null</span>,message.<span class="title function_">getBytes</span>());</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(message);</span><br><span class="line"></span><br><span class="line">        channel.<span class="title function_">close</span>();</span><br><span class="line">        connection.<span class="title function_">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">direct</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">utils</span>.<span class="property">ConnectionRabbitMQUtil</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">concurrent</span>.<span class="property">TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Consumer_01</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">        <span class="title class_">String</span> queue2Name = <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Consumer</span> consumer = <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="keyword">void</span> <span class="title function_">handleDelivery</span>(<span class="title class_">String</span> consumerTag, <span class="title class_">Envelope</span> envelope, <span class="variable constant_">AMQP</span>.<span class="property">BasicProperties</span> properties, byte[] body) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;将日志信息打印到控制台.....&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.<span class="title function_">basicConsume</span>(queue1Name,<span class="literal">true</span>,consumer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">Consumer_02</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">        <span class="title class_">String</span> queue2Name = <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Consumer</span> consumer = <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="keyword">void</span> <span class="title function_">handleDelivery</span>(<span class="title class_">String</span> consumerTag, <span class="title class_">Envelope</span> envelope, <span class="variable constant_">AMQP</span>.<span class="property">BasicProperties</span> properties, byte[] body) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;将日志信息打印到控制台.....&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.<span class="title function_">basicConsume</span>(queue2Name,<span class="literal">true</span>,consumer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-4-Topics通配符模式"><a href="#6-4-Topics通配符模式" class="headerlink" title="6.4 Topics通配符模式"></a>6.4 Topics通配符模式</h2><h3 id="6-4-1模式说明"><a href="#6-4-1模式说明" class="headerlink" title="6.4.1模式说明"></a>6.4.1模式说明</h3><p>Topic类型与Direct相比，都是可以根据RoutingKey把消息路由到不同的队列。只不过Topic类型Exchange可以让队列在绑定Routing key 的时候使用通配符！<br>Routingkey 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： item.insert<br><strong>通配符规则：</strong><br>#：匹配零个或多个词<br>*：匹配不多不少恰好1个词<br>举例：<br>item.#：能够匹配item.insert.abc 或者 item.insert<br>item.*：只能匹配item.insert<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-01-1678337560668-16ea480f-8ebd-4cbc-acad-e154c2470a4a-4bec27.png" alt="image.png"></p>
<hr>
<h3 id="6-4-2-代码实现"><a href="#6-4-2-代码实现" class="headerlink" title="6.4.2 代码实现"></a>6.4.2 代码实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">topic</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">utils</span>.<span class="property">ConnectionRabbitMQUtil</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">BuiltinExchangeType</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">Channel</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">Connection</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">concurrent</span>.<span class="property">TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">IOException</span>, <span class="title class_">TimeoutException</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.创建交换机</span></span><br><span class="line">        <span class="title class_">String</span> exchangeName = <span class="string">&quot;test_topic&quot;</span>;</span><br><span class="line">        <span class="comment">//发布订阅模式</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">        1. exchange：交换机名称</span></span><br><span class="line"><span class="comment">        2. type：交换机类型</span></span><br><span class="line"><span class="comment">            DIRECT(&quot;direct&quot;),：定向</span></span><br><span class="line"><span class="comment">            FANOUT(&quot;fanout&quot;),：扇形（广播）,发送消息到每一个与之绑定队列。</span></span><br><span class="line"><span class="comment">            TOPIC(&quot;topic&quot;),通配符的方式</span></span><br><span class="line"><span class="comment">            HEADERS(&quot;headers&quot;);参数匹配</span></span><br><span class="line"><span class="comment">        3. durable：是否持久化</span></span><br><span class="line"><span class="comment">        4. autoDelete：自动删除</span></span><br><span class="line"><span class="comment">        5. internal：内部使用。 一般false</span></span><br><span class="line"><span class="comment">        6. arguments：参数</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        channel.<span class="title function_">exchangeDeclare</span>(exchangeName, <span class="title class_">BuiltinExchangeType</span>.<span class="property">TOPIC</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">        <span class="title class_">String</span> queue2Name = <span class="string">&quot;test_topic_queue2&quot;</span>;</span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.<span class="title function_">queueDeclare</span>(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 绑定队列和交换机</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *  参数：</span></span><br><span class="line"><span class="comment">         1. queue：队列名称</span></span><br><span class="line"><span class="comment">         2. exchange：交换机名称</span></span><br><span class="line"><span class="comment">         3. routingKey：路由键,绑定规则</span></span><br><span class="line"><span class="comment">         如果交换机的类型为fanout ,routingKey设置为&quot;&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// routing key  系统的名称.日志的级别。</span></span><br><span class="line">        <span class="comment">//需求： 所有error级别的日志存入数据库,所有order系统的日志存入数据库</span></span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue1Name,exchangeName,<span class="string">&quot;#.error&quot;</span>);</span><br><span class="line">        channel.<span class="title function_">queueBind</span>(queue2Name,exchangeName,<span class="string">&quot;order.*&quot;</span>);</span><br><span class="line">        <span class="title class_">String</span> body1 = <span class="string">&quot;队列1.....&quot;</span>;</span><br><span class="line">        <span class="comment">//发送消息goods.info,goods.error</span></span><br><span class="line">        channel.<span class="title function_">basicPublish</span>(exchangeName,<span class="string">&quot;order.error&quot;</span>,<span class="literal">null</span>,body1.<span class="title function_">getBytes</span>());</span><br><span class="line">        channel.<span class="title function_">close</span>();</span><br><span class="line">        connection.<span class="title function_">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">topic</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">atguigu</span>.<span class="property">rabbitmq</span>.<span class="property">utils</span>.<span class="property">ConnectionRabbitMQUtil</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.*;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">Exception</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">        <span class="title class_">Consumer</span> consumer = <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="keyword">void</span> <span class="title function_">handleDelivery</span>(<span class="title class_">String</span> consumerTag, <span class="title class_">Envelope</span> envelope, <span class="variable constant_">AMQP</span>.<span class="property">BasicProperties</span> properties, byte[] body) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.<span class="title function_">basicConsume</span>(queue1Name,<span class="literal">true</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">Exception</span> &#123;</span><br><span class="line">        <span class="title class_">Connection</span> connection = <span class="title class_">ConnectionRabbitMQUtil</span>.<span class="title function_">getConnection</span>();</span><br><span class="line">        <span class="title class_">Channel</span> channel = connection.<span class="title function_">createChannel</span>();</span><br><span class="line">        <span class="title class_">String</span> queue1Name = <span class="string">&quot;test_topic_queue2&quot;</span>;</span><br><span class="line">        <span class="title class_">Consumer</span> consumer = <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="keyword">void</span> <span class="title function_">handleDelivery</span>(<span class="title class_">String</span> consumerTag, <span class="title class_">Envelope</span> envelope, <span class="variable constant_">AMQP</span>.<span class="property">BasicProperties</span> properties, byte[] body) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">                <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.<span class="title function_">basicConsume</span>(queue1Name,<span class="literal">true</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-5工作模式总结"><a href="#6-5工作模式总结" class="headerlink" title="6.5工作模式总结"></a>6.5工作模式总结</h2><p>RabbitMQ工作模式：<br><strong>1、简单模式 HelloWorld</strong><br>    一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-05-1678339333997-27c5b285-3d2c-47e6-89bf-ffd7edb326be-5b00da.png" alt="image.png"><br><strong>2、工作队列模式 Work Queue</strong><br>    一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-07-1678339337391-6a519bc5-f316-4b89-a53a-3771b8a7a3ae-3e5538.png" alt="image.png"><br><strong>3、发布订阅模式 Publish&#x2F;subscribe</strong><br>    需要设置类型为fanout的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-09-1678339342568-62870f80-fa25-4576-889d-98a09b51c430-6f6f6a.png" alt="image.png"><br><strong>4、路由模式 Routing</strong><br>    需要设置类型为direct的交换机，交换机和队列进行绑定，并且指定routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-10-1678339346814-610867a4-23fc-4ae9-8f48-ce4c5e190461-fe0993.png" alt="image.png"><br><strong>5、通配符模式 Topic</strong><br>    需要设置类型为topic的交换机，交换机和队列进行绑定，并且指定通配符方式的routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-12-1678339351348-8045ab1e-9d45-45d3-911c-6d54b1dc8261-4ff3c7.png" alt="image.png"></p>
<hr>
<h1 id="7-Spring整合RabbitMQ"><a href="#7-Spring整合RabbitMQ" class="headerlink" title="7.Spring整合RabbitMQ"></a>7.Spring整合RabbitMQ</h1><h2 id="7-1-生产者端"><a href="#7-1-生产者端" class="headerlink" title="7.1 生产者端"></a>7.1 生产者端</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>_07RabbitMQ<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbitmq-proverder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq.<span class="property">host</span>=<span class="number">192.168</span><span class="number">.10</span><span class="number">.101</span></span><br><span class="line">rabbitmq.<span class="property">port</span>=<span class="number">5672</span></span><br><span class="line">rabbitmq.<span class="property">username</span>=admin</span><br><span class="line">rabbitmq.<span class="property">password</span>=admin</span><br><span class="line">rabbitmq.<span class="property">virtual</span>-host=/</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/context</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbit.properties&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义RabbitAdmin对象，用于管理交换机、队列--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">        1.简单模式</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">        定义持久化队列,不存在则自动创建；不绑定到交换机则绑定到默认交换机</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">        默认交换机类型为direct,名字为：&quot;&quot;,路由键为队列的名称</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">    --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_queue&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring-simple-queue&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 2.广播模式   --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring-fanout-queue-1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring-fanout-queue-11&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring-fanout-queue-2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring-fanout-queue-22&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 绑定队列与交换机   --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:fanout-exchange</span> <span class="attr">name</span>=<span class="string">&quot;spring-fanout-exchange&quot;</span> <span class="attr">id</span>=<span class="string">&quot;spring-fanout-exchange&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;spring-fanout-queue-1&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;spring-fanout-queue-2&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">rabbit:fanout-exchange</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 3.主题（通配符）模式   --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!--定义主题交换机中的持久化队列,不存在则自动创建--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_queue_star&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_queue_star&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!--定义主题交换机中的持久化队列,不存在则自动创建--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_queue_well&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_queue_well&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!--定义主题交换机中的持久化队列,不存在则自动创建--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_queue_well2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_queue_well2&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_exchange&quot;</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_exchange&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;atguigu.*&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;spring_topic_queue_star&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;atguigu.#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;spring_topic_queue_well&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;guigu.#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;spring_topic_queue_well2&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--4.定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">junit</span>.<span class="property">Test</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">junit</span>.<span class="property">runner</span>.<span class="property">RunWith</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">amqp</span>.<span class="property">rabbit</span>.<span class="property">core</span>.<span class="property">RabbitTemplate</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">beans</span>.<span class="property">factory</span>.<span class="property">annotation</span>.<span class="property">Autowired</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">test</span>.<span class="property">context</span>.<span class="property">ContextConfiguration</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">test</span>.<span class="property">context</span>.<span class="property">junit4</span>.<span class="property">SpringRunner</span>;</span><br><span class="line"></span><br><span class="line">@<span class="title class_">RunWith</span>(<span class="title class_">SpringRunner</span>.<span class="property">class</span>)</span><br><span class="line">@<span class="title class_">ContextConfiguration</span>(locations = <span class="string">&quot;classpath:spring-rabbitmq.xml&quot;</span>)</span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">ProducerTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Autowired</span></span><br><span class="line">    private <span class="title class_">RabbitTemplate</span> rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.简单队列消息</span></span><br><span class="line"><span class="comment">     * 默认交换机类型为 direct</span></span><br><span class="line"><span class="comment">     * 交换机的名称为空,路由键为队列的名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="title class_">Test</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">queueTest</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//路由键与队列同名</span></span><br><span class="line">        rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;spring_simple_queue&quot;</span>, <span class="string">&quot;只发队列spring_sinple_queue的消息。&quot;</span>);</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;消息发送完毕........&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 广播模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="title class_">Test</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">fanoutTest</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：交换机名称</span></span><br><span class="line"><span class="comment">         * 参数2：路由键名（广播设置为空）</span></span><br><span class="line"><span class="comment">         * 参数3：发送的消息内容</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">          rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;spring-fanout-exchange&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;发送到spring_fanout_exchange交换机的广播消息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主题模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="title class_">Test</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title class_">TopicTest</span>()&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：交换机名称</span></span><br><span class="line"><span class="comment">         * 参数2：路由键名（广播设置为空）</span></span><br><span class="line"><span class="comment">         * 参数3：发送的消息内容</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;spring_topic_exchange&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;发送到spring_topic_exchange交换机的主题消息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通配符</span></span><br><span class="line"><span class="comment">     * 交换机类型为 topic</span></span><br><span class="line"><span class="comment">     * 匹配路由键的通配符,*表示一个单词,#表示多个单词</span></span><br><span class="line"><span class="comment">     * 绑定到该交换机的匹配队列能够收到对应消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="title class_">Test</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">topicTest</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：交换机名称</span></span><br><span class="line"><span class="comment">         * 参数2：路由键名</span></span><br><span class="line"><span class="comment">         * 参数3：发送的消息内容</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;spring_topic_exchange&quot;</span>, <span class="string">&quot;atguigu.bj&quot;</span>, <span class="string">&quot;发送到spring_topic_exchange交换机atguigu.bj的消息&quot;</span>);</span><br><span class="line">        rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;spring_topic_exchange&quot;</span>, <span class="string">&quot;guigu.cn&quot;</span>, <span class="string">&quot;发送到spring_topic_exchange交换机guigu.cn的消息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-2-消费者端"><a href="#7-2-消费者端" class="headerlink" title="7.2.消费者端"></a>7.2.消费者端</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/context</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbit.properties&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义RabbitAdmin对象，用于管理交换机、队列--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 1.配置简单模式队列监听器队列   --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springQueueListener&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguig.Listener.SpringQueueListener&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 2.广播队列--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springFanoutListener1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguig.Listener.SpringFanoutQueue1Listener&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springFanoutListener2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguig.Listener.SpringFanoutQueue2Listener&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--3.主题队列--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springTopic1Listener&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguig.Listener.SpringTopic1Listener&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springTopic2Listener&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguig.Listener.SpringTopic2Listener&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!-- 配置监听器   --&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 简单模式配置       --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springQueueListener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_simple_queue&quot;</span>/&gt;</span> //消费队列信息</span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 广播配置      --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springFanoutListener1&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring-fanout-queue-11&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springFanoutListener2&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring-fanout-queue-22&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 主题（通配符）队列       --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springTopic1Listener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_topic_queue_star&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springTopic2Listener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_topic_queue_well2&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单队列监听</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">SpringQueueListener</span> implements <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">onMessage</span>(<span class="params">Message message</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">String</span> msg = <span class="keyword">new</span> <span class="title class_">String</span>(message.<span class="title function_">getBody</span>(), <span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>);</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">printf</span>(<span class="string">&quot;接收路由名称为：%s,路由键为：%s,队列名为：%s的消息：%s \n&quot;</span>,</span><br><span class="line">                    message.<span class="title function_">getMessageProperties</span>().<span class="title function_">getReceivedExchange</span>(),</span><br><span class="line">                    message.<span class="title function_">getMessageProperties</span>().<span class="title function_">getReceivedRoutingKey</span>(),</span><br><span class="line">                    message.<span class="title function_">getMessageProperties</span>().<span class="title function_">getConsumerQueue</span>(),</span><br><span class="line">                    msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            e.<span class="title function_">printStackTrace</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">RunWith</span>(<span class="title class_">SpringJUnit4ClassRunner</span>.<span class="property">class</span>)</span><br><span class="line">@<span class="title class_">ContextConfiguration</span>(locations = <span class="string">&quot;classpath:spring-rabbitmq.xml&quot;</span>)</span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">CustomerTests</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Test</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">test1</span>(<span class="params"></span>)&#123;</span><br><span class="line">        boolean flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (flag)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="8-RabbitMQ高级特性"><a href="#8-RabbitMQ高级特性" class="headerlink" title="8.RabbitMQ高级特性"></a>8.RabbitMQ高级特性</h1><h2 id="8-1消息的可靠性传递（发送端）"><a href="#8-1消息的可靠性传递（发送端）" class="headerlink" title="8.1消息的可靠性传递（发送端）"></a>8.1消息的可靠性传递（发送端）</h2><p>在使用 RabbitMQ 的时候，作为消息发送方希望<strong>杜绝任何消息丢失</strong>或者<strong>投递失败</strong>场景。RabbitMQ 为我们提供了<strong>两种方式</strong>用来<strong>控制消息的投递可靠性模式</strong>。<br><strong>· confirm 确认模式</strong><br><strong>· return 退回模式</strong><br>rabbitmq 整个消息投递的路径为：<br>producer—&gt;rabbitmq broker—&gt;exchange—&gt;queue—&gt;consumer</p>
<pre><code>     1. 消息从 producer 到 exchange 则会返回一个 confirmCallback 。
     2. 消息从 exchange–&gt;queue 投递失败则会返回一个 returnCallback 。
</code></pre>
<h3 id="8-1-1-Confirm确认模式"><a href="#8-1-1-Confirm确认模式" class="headerlink" title="8.1.1 Confirm确认模式"></a>8.1.1 Confirm确认模式</h3><p>**    装配时要配置confirm为true** <code>publisher-confirms=&quot;true&quot; publisher-returns=&quot;true&quot;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq.<span class="property">host</span>=<span class="number">192.168</span><span class="number">.10</span><span class="number">.101</span></span><br><span class="line">rabbitmq.<span class="property">port</span>=<span class="number">5672</span></span><br><span class="line">rabbitmq.<span class="property">username</span>=admin</span><br><span class="line">rabbitmq.<span class="property">password</span>=admin</span><br><span class="line">rabbitmq.<span class="property">virtual</span>-host=/</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/context</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbit.properties&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span>  <span class="attr">publisher-confirms</span>=<span class="string">&quot;true&quot;</span> <span class="attr">publisher-returns</span>=<span class="string">&quot;true&quot;</span>  //<span class="attr">设置为true</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义RabbitAdmin对象，用于管理交换机、队列--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--绑定队列--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_confirm&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_confirm&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:direct-exchange</span> <span class="attr">name</span>=<span class="string">&quot;test_exchange_confirm&quot;</span> <span class="attr">id</span>=<span class="string">&quot;test_exchange_confirm&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">key</span>=<span class="string">&quot;confirm&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;test_queue_confirm&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">rabbit:direct-exchange</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    @<span class="title class_">Autowired</span></span><br><span class="line">    private <span class="title class_">RabbitTemplate</span> rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Test</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">queueTest</span>(<span class="params"></span>)&#123;</span><br><span class="line">       rabbitTemplate.<span class="title function_">setConfirmCallback</span>(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.<span class="title class_">ConfirmCallback</span>() &#123;</span><br><span class="line">           @<span class="title class_">Override</span></span><br><span class="line">           public <span class="keyword">void</span> <span class="title function_">confirm</span>(<span class="params">CorrelationData correlationData, boolean ack, <span class="built_in">String</span> cause</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ack)&#123;</span><br><span class="line">                    <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;接收消息成功：&quot;</span>+cause);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//接收失败</span></span><br><span class="line">                    <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;接收失败消息&quot;</span> + cause); </span><br><span class="line">                    <span class="comment">//做一些处理,让消息再次发送。</span></span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//       rabbitTemplate.convertAndSend(&quot;test_exchange_confirm&quot;,&quot;confirmss&quot;,&quot;message confirm&quot;.getBytes());//成功</span></span><br><span class="line">        rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;test_exchange_confirm000&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm....&quot;</span>);<span class="comment">//失败</span></span><br><span class="line">        <span class="comment">//接收失败消息channel error; protocol method: #method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange &#x27;test_exchange_confirm000&#x27; in vhost &#x27;/&#x27;, class-id=60, method-id=40)</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="8-1-2-Return退回模式"><a href="#8-1-2-Return退回模式" class="headerlink" title="8.1.2 Return退回模式"></a>8.1.2 Return退回模式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 回退模式： 当消息发送给Exchange后,Exchange路由到Queue失败时 才会执行 ReturnCallBack</span></span><br><span class="line"><span class="comment">   * 步骤：</span></span><br><span class="line"><span class="comment">   * 1. 开启回退模式：publisher-returns=&quot;true&quot;</span></span><br><span class="line"><span class="comment">   * 2. 设置ReturnCallBack</span></span><br><span class="line"><span class="comment">   * 3. 设置Exchange处理消息的模式：</span></span><br><span class="line"><span class="comment">   *      1). 如果消息没有路由到Queue,则丢弃消息（默认）</span></span><br><span class="line"><span class="comment">   *      2). 如果消息没有路由到Queue,返回给消息发送方ReturnCallBack</span></span><br><span class="line"><span class="comment">   *            rabbitTemplate.setMandatory(true);</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @<span class="title class_">Test</span></span><br><span class="line">  public <span class="keyword">void</span> <span class="title function_">testReturn</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">//设置交换机处理失败消息的模式</span></span><br><span class="line">      rabbitTemplate.<span class="title function_">setMandatory</span>(<span class="literal">true</span>);</span><br><span class="line">      <span class="comment">//2.设置ReturnCallBack</span></span><br><span class="line">      rabbitTemplate.<span class="title function_">setReturnCallback</span>(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.<span class="title class_">ReturnCallback</span>() &#123;</span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> message   消息对象</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> replyCode 错误码</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> replyText 错误信息</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> exchange  交换机</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          @<span class="title class_">Override</span></span><br><span class="line">          public <span class="keyword">void</span> <span class="title function_">returnedMessage</span>(<span class="params">Message message, int replyCode,<span class="built_in">String</span> replyText,<span class="built_in">String</span> exchange,<span class="built_in">String</span> routingKey</span>) &#123;</span><br><span class="line">              <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;return 执行了....&quot;</span>);</span><br><span class="line"></span><br><span class="line">              <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(message);</span><br><span class="line">              <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(replyCode);</span><br><span class="line">              <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(replyText);</span><br><span class="line">              <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(exchange);</span><br><span class="line">              <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(routingKey);</span><br><span class="line"></span><br><span class="line">              <span class="comment">//处理</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">//3. 发送消息</span></span><br><span class="line">      rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm4&quot;</span>, <span class="string">&quot;message confirm....&quot;</span>);<span class="comment">//失败</span></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      return 执行了....</span></span><br><span class="line"><span class="comment">      (Body:&#x27;message confirm....&#x27; MessageProperties [headers=&#123;&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, deliveryTag=0])</span></span><br><span class="line"><span class="comment">      312</span></span><br><span class="line"><span class="comment">      NO_ROUTE</span></span><br><span class="line"><span class="comment">      test_exchange_confirm</span></span><br><span class="line"><span class="comment">      confirm4</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-1-3消息的可靠投递小结"><a href="#8-1-3消息的可靠投递小结" class="headerlink" title="8.1.3消息的可靠投递小结"></a>8.1.3消息的可靠投递小结</h3><ul>
<li>设置 ConnectionFactory的publisher-confirms&#x3D;”true” 开启确认模式。</li>
<li>使用 rabbitTemplate.setConfirmCallback 设置回调函数。当消息发送到 exchange 后回调 confirm 方法。在方法中判断 ack，如果为true，则发送成功，如果为false，则发送失败，需要处理。</li>
<li>设置 ConnectionFactory 的 publisher-returns&#x3D;”true” 开启退回模式。</li>
<li>使用 rabbitTemplate.setReturnCallback 设置退回函数，当消息从<strong>exchange 路由到 queue 失败后，如果设置了 rabbitTemplate.setMandatory(true) 参数，则会将消息退回给 producer并执行回调函数returnedMessage</strong></li>
</ul>
<hr>
<h3 id="8-1-4Consumer-Ack（接收端）"><a href="#8-1-4Consumer-Ack（接收端）" class="headerlink" title="8.1.4Consumer Ack（接收端）"></a>8.1.4Consumer Ack（接收端）</h3><ul>
<li>ack指Acknowledge，确认。 表示消费端收到消息后的确认方式。</li>
</ul>
<p>有二种确认方式：<br>· 自动确认：acknowledge&#x3D;“none” 默认<br>· 手动确认：acknowledge&#x3D;“manual”</p>
<ul>
<li>其中自动确认是指，当消息一旦被Consumer接收到，则自动确认收到，并将相应 message 从 RabbitMQ 的消息缓存中移除。但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该消息就会丢失。</li>
<li><strong>如果设置了手动确认方式，则需要在业务处理成功后，调用channel.basicAck()，手动签收，如果出现异常，则调用channel.basicNack()方法，让其自动重新发送消息。</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/context</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.atguig&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbit.properties&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 定义RabbitAdmin对象，用于管理交换机、队列--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--绑定队列-监听器--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">acknowledge</span>=<span class="string">&quot;manual&quot;</span>&gt;</span>   <span class="comment">&lt;!--设置手动确认 --&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;ackListener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;test_queue_confirm&quot;</span>/&gt;</span>    <span class="comment">&lt;!--设置监听的队列 --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span>  </span></span><br><span class="line"><span class="language-xml">                                 </span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguig</span>.<span class="property">Listener</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">rabbitmq</span>.<span class="property">client</span>.<span class="property">Channel</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">amqp</span>.<span class="property">core</span>.<span class="property">Message</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">amqp</span>.<span class="property">rabbit</span>.<span class="property">listener</span>.<span class="property">api</span>.<span class="property">ChannelAwareMessageListener</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">stereotype</span>.<span class="property">Component</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Consumer ACK机制：</span></span><br><span class="line"><span class="comment"> *  1. 设置手动签收。acknowledge=&quot;manual&quot;</span></span><br><span class="line"><span class="comment"> *  2. 让监听器类实现ChannelAwareMessageListener接口</span></span><br><span class="line"><span class="comment"> *  3. 如果消息成功处理,则调用channel的 basicAck()签收</span></span><br><span class="line"><span class="comment"> *  4. 如果消息处理失败,则调用channel的basicNack()拒绝签收,broker重新发送给consumer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="title class_">Component</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">AckListener</span> implements <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">onMessage</span>(<span class="title class_">Message</span> message, <span class="title class_">Channel</span> channel) throws <span class="title class_">Exception</span> &#123;</span><br><span class="line">        <span class="title class_">Thread</span>.<span class="title function_">sleep</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 获取消息传递标记</span></span><br><span class="line">        long deliveryTag = message.<span class="title function_">getMessageProperties</span>().<span class="title function_">getDeliveryTag</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;deliveryTag:&quot;</span>+deliveryTag);</span><br><span class="line">            <span class="comment">// ① 接收消息</span></span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="keyword">new</span> <span class="title class_">String</span>(message.<span class="title function_">getBody</span>()));</span><br><span class="line">            <span class="comment">// ② 处理业务逻辑</span></span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;处理业务逻辑&quot;</span>);</span><br><span class="line"><span class="comment">//            int i = 3/0;//出现错误</span></span><br><span class="line">            <span class="comment">// ③ 手动签收</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 第一个参数：表示收到的标签</span></span><br><span class="line"><span class="comment">             * 第二个参数：如果为true表示可以签收所有的消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.<span class="title function_">basicAck</span>(deliveryTag,<span class="literal">true</span>);  <span class="comment">//手动提交</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            e.<span class="title function_">printStackTrace</span>();</span><br><span class="line">            <span class="comment">// ④ 拒绝签收</span></span><br><span class="line">             <span class="comment">/*</span></span><br><span class="line"><span class="comment">            第三个参数：requeue：重回队列。</span></span><br><span class="line"><span class="comment">            设置为true,则消息重新回到queue,broker会重新发送该消息给消费端</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.<span class="title function_">basicNack</span>(deliveryTag,<span class="literal">true</span>,<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-2消费限流"><a href="#8-2消费限流" class="headerlink" title="8.2消费限流"></a>8.2消费限流</h2><p>​      <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-24-1678360395677-596b36e2-ca84-410a-8c23-341dc9bd6cb3-a3824a.png" alt="image.png"></p>
<ul>
<li><p><strong>prefetch &#x3D; 1,表示消费端每次从mq拉去一条消息来消费,直到手动确认消费完毕后,才会继续拉取下一条消息。</strong></p>
</li>
<li><p>在 <a href="rabbit:listener-container">rabbit:listener-container</a>中配置 prefetch 属性设置消费端一次拉取多少条消息</p>
</li>
<li><p>消费端的必须确认才会继续处理其他消息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-27-1678360917884-6fef7eb7-53fc-4807-a2a5-f7c47a900aeb-edf9ba.png" alt="image.png"></p>
</li>
</ul>
<hr>
<h2 id="8-3TTL"><a href="#8-3TTL" class="headerlink" title="8.3TTL"></a>8.3TTL</h2><p>  TTL 全称 Time To Live（存活时间&#x2F;过期时间）。<br> 当消息到达存活时间后，还没有被消费，会被自动清除。<br>** RabbitMQ可以对消息设置过期时间，也可以对整个队列（Queue）设置过期时间。**<br>   <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-30-1678365046312-c126d7db-0884-40cf-a420-04cb75c0035d-9df4ff.png" alt="image.png"></p>
<hr>
<h3 id="8-3-1-配置队列过期时间"><a href="#8-3-1-配置队列过期时间" class="headerlink" title="8.3.1 配置队列过期时间"></a>8.3.1 配置队列过期时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--绑定队列--&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_confirm&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_confirm&quot;</span> <span class="attr">auto-declare</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-message-ttl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>​      <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-33-1678365244641-ec0f62ba-c79a-4dad-aa2f-4e9038665da6-b5c13c.png" alt="image.png"></p>
<hr>
<h3 id="8-3-2-消息过期时间"><a href="#8-3-2-消息过期时间" class="headerlink" title="8.3.2 消息过期时间"></a>8.3.2 消息过期时间</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * TTL：过期时间</span></span><br><span class="line"><span class="comment">    *  1. 队列统一过期</span></span><br><span class="line"><span class="comment">    *  2. 消息单独过期</span></span><br><span class="line"><span class="comment">    * 如果设置了消息的过期时间,也设置了队列的过期时间,它以时间短的为准。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   @<span class="title class_">Test</span></span><br><span class="line">   public <span class="keyword">void</span> <span class="title function_">testMessageTtl</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="comment">// 消息后处理对象,设置一些消息的参数信息</span></span><br><span class="line">       <span class="title class_">MessagePostProcessor</span> messagePostProcessor = <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line"></span><br><span class="line">           @<span class="title class_">Override</span></span><br><span class="line">           public <span class="title class_">Message</span> <span class="title function_">postProcessMessage</span>(<span class="title class_">Message</span> message) throws <span class="title class_">AmqpException</span> &#123;</span><br><span class="line">               <span class="comment">//1.设置message的信息</span></span><br><span class="line">               <span class="comment">// 第二个方法：消息的过期时间 ,5秒之后过期</span></span><br><span class="line">               message.<span class="title function_">getMessageProperties</span>().<span class="title function_">setExpiration</span>(<span class="string">&quot;5000&quot;</span>);</span><br><span class="line">               <span class="comment">//2.返回该消息</span></span><br><span class="line">               <span class="keyword">return</span> message;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//消息单独过期</span></span><br><span class="line">       rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="string">&quot;test_exchange_ttl&quot;</span>,<span class="string">&quot;ttl.hehe&quot;</span>,<span class="string">&quot;message ttl....&quot;</span>,messagePostProcessor);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-4死信队列"><a href="#8-4死信队列" class="headerlink" title="8.4死信队列"></a>8.4死信队列</h2><p>死信队列，英文缩写：DLX 。DeadLetter Exchange（死信交换机），<strong>当消息成为Dead message后</strong>，可以被重新发送到另一个交换机，这个交换机就是<strong>DLX</strong>。</p>
<h3 id="8-4-1什么是死信队列"><a href="#8-4-1什么是死信队列" class="headerlink" title="8.4.1什么是死信队列"></a>8.4.1什么是死信队列</h3><p>死信，顾名思义就是无法被消费的消息，字面意思可以这样理解，一般来说，producer将消息投递到broker或者直接到queue里了，consumer从queue取出消息进行消费，但某些时候由于特定的原因导致queue中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信，自然就有了死信队列；<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-37-1678433014870-a2625a5e-ddce-4524-930f-b2de4e553358-f2bcc1.png" alt="image.png"><br><strong>消息成为死信的三种情况：</strong><br>  &lt;1&gt; 队列消息数量到达限制；比如队列最大只能存储10条消息，而发了11条消息，根据先进先出，最先发的消息会进入死信队列。<br>  &lt;2&gt;消费者拒接消费消息<strong>，basicNack&#x2F;basicReject</strong>，并且不把消息重新放入原目标队列，requeue&#x3D;false；<br>  &lt;3&gt;原队列存在消息过期设置，消息到达超时时间未被消费；</p>
<p><strong>死信的处理方式:</strong><br>死信的产生既然不可避免，那么就需要从实际的业务角度和场景出发，对这些死信进行后续的处理，常见的处理方式:<br>① 丢弃，如果不是很重要，可以选择丢弃<br>② 记录死信入库，然后做后续的业务分析或处理<br><strong>③ 通过死信队列，由负责监听死信的应用程序进行处理</strong></p>
<p><strong>队列绑定死信交换机：</strong><br>     给队列设置参数：x-dead-letter-exchange 和x-dead-letter-routing-key</p>
<h3 id="8-4-2-过期时间处理代码"><a href="#8-4-2-过期时间处理代码" class="headerlink" title="8.4.2 过期时间处理代码"></a>8.4.2 过期时间处理代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> &lt;!-- <span class="number">1.</span>正常队列   --&gt;</span><br><span class="line"> <span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_dlx&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_dlx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="comment">&lt;!--  绑定死信队列        --&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!--3.1 x-dead-letter-exchange：死信交换机名称--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-exchange&quot;</span> <span class="attr">value</span>=<span class="string">&quot;exchange_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!--3.2 x-dead-letter-routing-key：发送给死信交换机的routingkey--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-routing-key&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dlx.hehe&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!--4.1 设置队列的过期时间10s ttl--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-message-ttl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">         </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span></span><br><span class="line"> </span><br><span class="line"> &lt;!-- <span class="number">2.</span>正常交换机   --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">&quot;test_exchange_dlx&quot;</span> <span class="attr">id</span>=<span class="string">&quot;test_exchange_dlx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;test.dlx.#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;test_queue_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &lt;!--<span class="number">3.</span>死信队列    --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;queue_dlx&quot;</span> <span class="attr">name</span>=<span class="string">&quot;queue_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"></span><br><span class="line"> &lt;!--<span class="number">4.</span>死信交换机    --&gt;</span><br><span class="line"> <span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">&quot;exchange_dlx&quot;</span> <span class="attr">id</span>=<span class="string">&quot;exchange_dlx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;dlx.#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;queue_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="8-4-3-长度限制处理"><a href="#8-4-3-长度限制处理" class="headerlink" title="8.4.3 长度限制处理"></a>8.4.3 长度限制处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> &lt;!-- ####################################死信队列测试###################################################################--&gt;</span><br><span class="line"> &lt;!--</span><br><span class="line">     死信队列：</span><br><span class="line">         <span class="number">1.</span> 声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx)</span><br><span class="line">         <span class="number">2.</span> 声明死信队列(queue_dlx)和死信交换机(exchange_dlx)</span><br><span class="line">         <span class="number">3.</span> 正常队列绑定死信交换机</span><br><span class="line">             设置两个参数：</span><br><span class="line">                 * x-dead-letter-exchange：死信交换机名称</span><br><span class="line">                 * x-dead-letter-routing-key：发送给死信交换机的routingkey</span><br><span class="line"> --&gt;</span><br><span class="line"> &lt;!-- <span class="number">1.</span>正常队列   --&gt;</span><br><span class="line"> <span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_dlx&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_dlx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="comment">&lt;!--  绑定死信队列        --&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!--3.1 x-dead-letter-exchange：死信交换机名称--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-exchange&quot;</span> <span class="attr">value</span>=<span class="string">&quot;exchange_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!--3.2 x-dead-letter-routing-key：从新设置消息的key发送给死信交换机的routingkey--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-routing-key&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dlx.hehe&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!--4.2 设置队列的长度限制 max-length --&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-max-length&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">         </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span></span><br><span class="line"> </span><br><span class="line"> &lt;!-- <span class="number">2.</span>正常交换机   --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">&quot;test_exchange_dlx&quot;</span> <span class="attr">id</span>=<span class="string">&quot;test_exchange_dlx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;test.dlx.#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;test_queue_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &lt;!--<span class="number">3.</span>死信队列    --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;queue_dlx&quot;</span> <span class="attr">name</span>=<span class="string">&quot;queue_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"></span><br><span class="line"> &lt;!--<span class="number">4.</span>死信交换机    --&gt;</span><br><span class="line"> <span class="language-xml"><span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">&quot;exchange_dlx&quot;</span> <span class="attr">id</span>=<span class="string">&quot;exchange_dlx&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;dlx.#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;queue_dlx&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-39-1678435038212-079dcb80-7507-4541-8866-996ea3aceaf6-5a4b39.png" alt="image.png"></p>
<hr>
<h3 id="8-4-4消息拒收"><a href="#8-4-4消息拒收" class="headerlink" title="8.4.4消息拒收"></a>8.4.4消息拒收</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Component</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">QueueDLX</span> implements <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">onMessage</span>(<span class="title class_">Message</span> message, <span class="title class_">Channel</span> channel) throws <span class="title class_">Exception</span> &#123;</span><br><span class="line">        long deliveryTag = message.<span class="title function_">getMessageProperties</span>().<span class="title function_">getDeliveryTag</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.接收转换消息</span></span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="keyword">new</span> <span class="title class_">String</span>(message.<span class="title function_">getBody</span>()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;处理业务逻辑...&quot;</span>);</span><br><span class="line">            int i = <span class="number">3</span>/<span class="number">0</span>;<span class="comment">//出现错误</span></span><br><span class="line">            <span class="comment">//3. 手动签收</span></span><br><span class="line">            channel.<span class="title function_">basicAck</span>(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            <span class="comment">//e.printStackTrace();</span></span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;出现异常,拒绝接受&quot;</span>);</span><br><span class="line">            <span class="comment">//4.拒绝签收,不重回队列 requeue=false</span></span><br><span class="line">            channel.<span class="title function_">basicNack</span>(deliveryTag,<span class="literal">true</span>,<span class="literal">false</span>);   <span class="comment">//会进入死信队列</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-42-1678435652093-d5ed0bf6-5b49-4257-87d9-f98edad97c45-753ba2.png" alt="image.png"></p>
<hr>
<h2 id="8-5-延迟队列"><a href="#8-5-延迟队列" class="headerlink" title="8.5 延迟队列"></a>8.5 延迟队列</h2><p>延迟队列存储的对象肯定是对应的延时消息，所谓”延时消息”是指当消息被发送以后，并不想让消费者立即拿到消息，而是等待指定时间后，消费者才拿到这个消息进行消费。<br>场景：在订单系统中，一个用户下单之后通常有30分钟的时间进行支付，如果30分钟之内没有支付成功，那么这个订单将进行取消处理。这时就可以使用延时队列将订单信息发送到延时队列。<br>需求：</p>
<ol>
<li>下单后，30分钟未支付，取消订单，回滚库存。</li>
<li>新用户注册成功30分钟后，发送短信问候。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-44-1678435968296-b8a671a9-adf4-455d-9578-e285a32a9096-25582e.png" alt="image.png"><br>很可惜，在RabbitMQ中并未提供延迟队列功能。<br>但是可以使用：TTL+死信队列 组合实现延迟队列的效果。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-41-47-1678435986883-50693580-d111-43ce-b7a0-6a7b7461ca22-8df760.png" alt="image.png"></li>
</ol>
<hr>
<h1 id="9-SpringBoot集成MQ"><a href="#9-SpringBoot集成MQ" class="headerlink" title="9.SpringBoot集成MQ"></a>9.SpringBoot集成MQ</h1><hr>
<h2 id="9-1整合"><a href="#9-1整合" class="headerlink" title="9.1整合"></a>9.1整合</h2><h3 id="9-1-2生产者"><a href="#9-1-2生产者" class="headerlink" title="9.1.2生产者"></a>9.1.2生产者</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!--<span class="number">2.</span> rabbitmq--&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring</span>:</span><br><span class="line">  <span class="attr">rabbitmq</span>:</span><br><span class="line">    <span class="attr">host</span>: <span class="number">192.168</span><span class="number">.10</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">port</span>: <span class="number">5672</span></span><br><span class="line">    <span class="attr">username</span>: admin</span><br><span class="line">    <span class="attr">password</span>: admin</span><br><span class="line">    virtual-<span class="attr">host</span>: /</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">config</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">amqp</span>.<span class="property">core</span>.*;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">beans</span>.<span class="property">factory</span>.<span class="property">annotation</span>.<span class="property">Qualifier</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">context</span>.<span class="property">annotation</span>.<span class="property">Bean</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">context</span>.<span class="property">annotation</span>.<span class="property">Configuration</span>;</span><br><span class="line"></span><br><span class="line">@<span class="title class_">Configuration</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">EXCHANGE_NAME</span> = <span class="string">&quot;boot_topic_exchange&quot;</span>;</span><br><span class="line">    public <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">QUEUE_NAME</span> = <span class="string">&quot;boot_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1 交换机</span></span><br><span class="line">    @<span class="title class_">Bean</span>(<span class="string">&quot;bootExchange&quot;</span>)</span><br><span class="line">    public <span class="title class_">Exchange</span>  <span class="title function_">bootExchange</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="title class_">ExchangeBuilder</span>.<span class="title function_">topicExchange</span>(<span class="variable constant_">EXCHANGE_NAME</span>).<span class="title function_">durable</span>(<span class="literal">true</span>).<span class="title function_">build</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.Queue 队列</span></span><br><span class="line">    @<span class="title class_">Bean</span>(<span class="string">&quot;bootQueue&quot;</span>)</span><br><span class="line">    public <span class="title class_">Queue</span> <span class="title function_">bootQueue</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="title class_">QueueBuilder</span>.<span class="title function_">durable</span>(<span class="variable constant_">QUEUE_NAME</span>).<span class="title function_">build</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 队列和交互机绑定关系 Binding</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1. 知道哪个队列</span></span><br><span class="line"><span class="comment">        2. 知道哪个交换机</span></span><br><span class="line"><span class="comment">        3. routing key</span></span><br><span class="line"><span class="comment">        noargs()：表示不指定参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="title class_">Bean</span></span><br><span class="line">    public  <span class="title class_">Binding</span> <span class="title function_">bindingQueueExchange</span>(<span class="params">@Qualifier(<span class="string">&quot;bootQueue&quot;</span>) Queue queue,@Qualifier(<span class="string">&quot;bootExchange&quot;</span>) Exchange exchange</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">BindingBuilder</span>.<span class="title function_">bind</span>(queue).<span class="title function_">to</span>(exchange).<span class="title function_">with</span>(<span class="string">&quot;boot.#&quot;</span>).<span class="title function_">noargs</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringbootRabbitmqProviderApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Autowired</span></span><br><span class="line">    private <span class="title class_">RabbitTemplate</span> rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span>(<span class="params"></span>) &#123;</span><br><span class="line">        rabbitTemplate.<span class="title function_">convertAndSend</span>(<span class="title class_">RabbitConfig</span>.<span class="property">EXCHANGE_NAME</span>,<span class="string">&quot;boot.YXT&quot;</span>,<span class="string">&quot;mq Springboot&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="9-1-3消费者"><a href="#9-1-3消费者" class="headerlink" title="9.1.3消费者"></a>9.1.3消费者</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring</span>:</span><br><span class="line">  <span class="attr">rabbitmq</span>:</span><br><span class="line">    <span class="attr">host</span>: <span class="number">192.168</span><span class="number">.10</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">port</span>: <span class="number">5672</span></span><br><span class="line">    <span class="attr">username</span>: admin</span><br><span class="line">    <span class="attr">password</span>: admin</span><br><span class="line">    virtual-<span class="attr">host</span>: /</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Component</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">RabbimtMQListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">RabbitListener</span>(queues = <span class="string">&quot;boot_queue&quot;</span>)  <span class="comment">//监听的队列</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">listenerQueue</span>(<span class="params">Message message</span>)&#123;</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(message.<span class="title function_">getMessageProperties</span>().<span class="title function_">getDeliveryTag</span>());</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="keyword">new</span> <span class="title class_">String</span>(message.<span class="title function_">getBody</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-1SpringBoot在消费端绑定"><a href="#9-1SpringBoot在消费端绑定" class="headerlink" title="9.1SpringBoot在消费端绑定"></a>9.1SpringBoot在消费端绑定</h2><p>** 在消费端绑定交换机，队列，路由key**<br>** order—-&gt;hosp—–&gt;sms**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConst</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 预约下单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT_ORDER</span> <span class="operator">=</span> <span class="string">&quot;exchange.direct.order&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_ORDER</span> <span class="operator">=</span> <span class="string">&quot;order&quot;</span>;</span><br><span class="line">    <span class="comment">//队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_ORDER</span>  <span class="operator">=</span> <span class="string">&quot;queue.order&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT_MSM</span> <span class="operator">=</span> <span class="string">&quot;exchange.direct.msm&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_MSM_ITEM</span> <span class="operator">=</span> <span class="string">&quot;msm.item&quot;</span>;</span><br><span class="line">    <span class="comment">//队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_MSM_ITEM</span>  <span class="operator">=</span> <span class="string">&quot;queue.msm.item&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HospitalReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ScheduleService scheduleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(value = MqConst.QUEUE_ORDER,durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = MqConst.EXCHANGE_DIRECT_ORDER),</span></span><br><span class="line"><span class="meta">            key = &#123;MqConst.ROUTING_ORDER&#125;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiver</span><span class="params">(OrderMqVo orderMqVo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Schedule</span> <span class="variable">schedule</span> <span class="operator">=</span> scheduleService.getById(orderMqVo.getScheduleId());</span><br><span class="line">        schedule.setReservedNumber(orderMqVo.getReservedNumber());</span><br><span class="line">        schedule.setAvailableNumber(orderMqVo.getAvailableNumber());</span><br><span class="line">        scheduleService.update(schedule);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//更新后发送短信告知</span></span><br><span class="line">        <span class="type">MsmVo</span> <span class="variable">msmVo</span> <span class="operator">=</span> orderMqVo.getMsmVo();</span><br><span class="line">        <span class="keyword">if</span> (msmVo!=<span class="literal">null</span>)&#123;</span><br><span class="line">            rabbitService.sendMessage(MqConst.EXCHANGE_DIRECT_MSM,MqConst.QUEUE_MSM_ITEM,msmVo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费者端创建交换机，绑定交换机，绑定队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MsmService msmService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(</span></span><br><span class="line"><span class="meta">    bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">                value = @Queue(value = MqConst.ROUTING_MSM_ITEM,durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">                exchange = @Exchange(value = MqConst.EXCHANGE_DIRECT_MSM),</span></span><br><span class="line"><span class="meta">                key = &#123;MqConst.ROUTING_MSM_ITEM&#125;</span></span><br><span class="line"><span class="meta">                )</span></span><br><span class="line"><span class="meta">         )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(MsmVo msmVo, Message message, Channel channel)</span> &#123;</span><br><span class="line">        msmService.send(msmVo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Service</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">RabbitService</span> &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Autowired</span></span><br><span class="line">    private <span class="title class_">RabbitTemplate</span> rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public boolean <span class="title function_">sendMessage</span>(<span class="params"><span class="built_in">String</span> exchange, <span class="built_in">String</span> routingKey, <span class="built_in">Object</span> message</span>) &#123;</span><br><span class="line">        rabbitTemplate.<span class="title function_">convertAndSend</span>(exchange, routingKey, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<hr>
<h1 id="10-消息百分百成功投递"><a href="#10-消息百分百成功投递" class="headerlink" title="10.消息百分百成功投递"></a>10.消息百分百成功投递</h1><h2 id="10-1-生产者端"><a href="#10-1-生产者端" class="headerlink" title="10.1 生产者端"></a>10.1 生产者端</h2><p>​       <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-54-1678443673539-835ef2e7-4801-47fb-b7dd-589533f1a8de-a75293.png" alt="image.png"></p>
<p>Step 1： 首先把消息信息(业务数据）存储到数据库中，紧接着，我们再把这个消息记录也存储到一张消息记录表里（或者另外一个同源数据库的消息记录表）;<br>Step 2：发送消息到MQ Broker节点（采用confirm方式发送，会有异步的返回结果）;<br>Step 3、4：生产者端接受MQ Broker节点返回的Confirm确认消息结果，然后进行更新消息记录表里的消息状态。比如默认Status &#x3D; 0 当收到消息确认成功后，更新为1即可！<br>Step 5：但是在消息确认这个过程中可能由于网络闪断、MQ Broker端异常等原因导致 回送消息失败或者异常。这个时候就需要发送方（生产者）对消息进行可靠性投递了，保障消息不丢失，100%的投递成功！（有一种极限情况是闪断，Broker返回的成功确认消息，但是生产端由于网络闪断没收到，这个时候重新投递可能会造成消息重复，需要消费端去做幂等处理）<strong>所以我们需要有一个定时任务</strong>，（比如每5分钟拉取一下处于中间状态的消息，当然这个消息可以设置一个超时时间，比如超过1分钟 Status &#x3D; 0 ，也就说明了1分钟这个时间窗口内，我们的消息没有被确认，那么会被定时任务拉取出来）<br>Step 6：接下来我们把中间状态的消息进行重新投递 retry send，继续发送消息到MQ ，当然也可能有多种原因导致发送失败<br>Step 7：我们可以采用设置最大努力尝试次数，比如投递了3次，**还是失败，那么我们可以将最终状态设置为Status &#x3D; 2 **，最后 交由人工解决处理此类问题（或者把消息转储到失败表中）。</p>
<h2 id="10-2-消费幂等性"><a href="#10-2-消费幂等性" class="headerlink" title="10.2 消费幂等性"></a>10.2 消费幂等性</h2><p>​        <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-40-57-1678444277071-20012fa8-a1ff-41c7-9321-98c2e401e436-b0d6ae.png" alt="image.png"></p>
<p><strong>消息幂等性保障乐观锁机制</strong><br>生产者发送消息：<br><code>id=1,money=500,version=1</code><br>消费者接收消息<br><code>id=1,money=500,version=1</code><br><code>id=1,money=500,version=1</code><br>消费者需要保证幂等性：第一次执行SQL语句<br>第一次执行：version&#x3D;1<br><code>update account **set** money = money - 500 , version = version + 1 **where** id = 1 **and** version = 1</code></p>
<p>消费者需要保证幂等性：第二次执行SQL语句<br>第二次执行：version&#x3D;2     (版本已经变更，更新不到了，保证了幂等性)<br><code>update account **set** money = money - 500 , version = version + 1 **where** id = 1 **and** version = 1</code></p>
<hr>
<h1 id="11-Springboot消息确认"><a href="#11-Springboot消息确认" class="headerlink" title="11.Springboot消息确认"></a>11.Springboot消息确认</h1><h2 id="11-1-搭建环境"><a href="#11-1-搭建环境" class="headerlink" title="11.1 搭建环境"></a>11.1 搭建环境</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq:</span><br><span class="line">  host: <span class="number">192.168</span><span class="number">.10</span><span class="number">.101</span></span><br><span class="line">  port: <span class="number">5672</span></span><br><span class="line">  username: guest</span><br><span class="line">  password: guest</span><br><span class="line">  publisher-confirms-type: correlated <span class="comment">// 交换机的确认</span></span><br><span class="line">  publisher-returns: <span class="literal">true</span> <span class="comment">// 队列的确认</span></span><br><span class="line">  listener:</span><br><span class="line">    simple:</span><br><span class="line">      acknowledge-mode: manual #默认情况下消息消费者是自动确认消息的，如果要手动确认消息则需要修改确认模式为manual</span><br><span class="line">      prefetch: <span class="number">1</span> # 消费者每次从队列获取的消息数量。此属性当不设置时为：轮询分发，设置为<span class="number">1</span>为：公平分发</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">消息持久化</span><br><span class="line"><span class="meta">@Queue</span>注解中的属性 - autoDelete：当所有消费客户端连接断开后，是否自动删除队列 。<span class="literal">true</span>：删除 <span class="literal">false</span>：不删除</span><br><span class="line"><span class="meta">@Exchange</span>注解中的属性 - autoDelete：当交换器所有的绑定队列都不再使用时，是否自动删除交换器（更粗粒度，不建议）。<span class="literal">true</span>：删除 <span class="literal">false</span>：不删除</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!--rabbitmq消息队列--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!--rabbitmq 协议--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<h2 id="11-2-生产端消息确认配置1"><a href="#11-2-生产端消息确认配置1" class="headerlink" title="11.2 生产端消息确认配置1"></a>11.2 生产端消息确认配置1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.gmall.common.model;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GmallCorrelationData</span> <span class="keyword">extends</span> <span class="title class_">CorrelationData</span> &#123;</span><br><span class="line">    <span class="comment">//  消息主体</span></span><br><span class="line">    <span class="keyword">private</span> Object message;</span><br><span class="line">    <span class="comment">//  交换机</span></span><br><span class="line">    <span class="keyword">private</span> String exchange;</span><br><span class="line">    <span class="comment">//  路由键</span></span><br><span class="line">    <span class="keyword">private</span> String routingKey;</span><br><span class="line">    <span class="comment">//  重试次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//  消息类型  是否是延迟消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isDelay</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//  延迟时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">delayTime</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">mport org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 消息发送确认</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * ConfirmCallback  只确认消息是否正确到达 Exchange 中</span></span><br><span class="line"><span class="comment"> * ReturnCallback   消息没有正确到达队列时触发回调，如果正确到达队列不执行</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 1. 如果消息没有到exchange,则confirm回调,ack=false</span></span><br><span class="line"><span class="comment"> * 2. 如果消息到达exchange,则confirm回调,ack=true</span></span><br><span class="line"><span class="comment"> * 3. exchange到queue成功,则不回调return</span></span><br><span class="line"><span class="comment"> * 4. exchange到queue失败,则回调return</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerAckConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnCallback&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);            <span class="comment">//指定 ConfirmCallback</span></span><br><span class="line">        rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);             <span class="comment">//指定 ReturnCallback</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ack)&#123;</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;消息发送成功:&quot;</span>+ JSON.toJSONString(correlationData));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">             log.info(<span class="string">&quot;消息发送失败：&quot;</span>+cause+<span class="string">&quot;数据&quot;</span>+JSON.toJSONString(correlationData) );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">        <span class="comment">//1.反序列化对象输出</span></span><br><span class="line">        System.out.println(<span class="string">&quot;消息主体: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        System.out.println(<span class="string">&quot;应答码:&quot;</span>+replyCode);</span><br><span class="line">        System.out.println(<span class="string">&quot;描述：&quot;</span> + replyText);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息使用的交换器 exchange : &quot;</span> + exchange);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息使用的路由键 routing : &quot;</span> + routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息主体: 生产者:发送消息...........</span></span><br><span class="line"><span class="comment">     * 应答码:312</span></span><br><span class="line"><span class="comment">     * 描述：NO_ROUTE</span></span><br><span class="line"><span class="comment">     * 消息使用的交换器 exchange : exchange.confirm</span></span><br><span class="line"><span class="comment">     * 消息使用的路由键 routing : routing.confirm.error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-3生产端消息确认配置-（百分百发送）"><a href="#11-3生产端消息确认配置-（百分百发送）" class="headerlink" title="11.3生产端消息确认配置:（百分百发送）"></a>11.3生产端消息确认配置:（百分百发送）</h2><pre><code>  ①在发送端，封装要发送的信息，存入redis
  ②重试的时候获取 GmallCorrelationData类,
  ③重新发送
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.gmall.common.config;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.model.GmallCorrelationData;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerAckConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback,RabbitTemplate.ReturnCallback &#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span>  RabbitTemplate rabbitTemplate;</span><br><span class="line">        <span class="meta">@PostConstruct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  确认消息是否到达交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;消息发送成功：&quot;</span> + JSON.toJSONString(correlationData));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;消息发送失败：&quot;</span> + cause + <span class="string">&quot; 数据：&quot;</span> + JSON.toJSONString(correlationData));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.retryMessage(correlationData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确实消息是否正确到达队列</span></span><br><span class="line"><span class="comment">     * 执行时机：</span></span><br><span class="line"><span class="comment">     *  到达不执行</span></span><br><span class="line"><span class="comment">     *  没到执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyText</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message,<span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消息主体: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        System.out.println(<span class="string">&quot;应答码: &quot;</span> + replyCode);</span><br><span class="line">        System.out.println(<span class="string">&quot;描述：&quot;</span> + replyText);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息使用的交换器 exchange : &quot;</span> + exchange);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息使用的路由键 routing : &quot;</span> + routingKey);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从redis中获取数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">correlationDataId</span> <span class="operator">=</span> (String) message.getMessageProperties().getHeaders().get(<span class="string">&quot;spring_returned_message_correlation&quot;</span>);</span><br><span class="line">        <span class="comment">//从redis中获取数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">strJson</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(correlationDataId);</span><br><span class="line">        GmallCorrelationData gmallCorrelationData= JSON.parseObject(strJson, GmallCorrelationData.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用重试方法</span></span><br><span class="line">        <span class="built_in">this</span>.retryMessage(gmallCorrelationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现重试方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retryMessage</span><span class="params">(CorrelationData correlationData)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换</span></span><br><span class="line">        GmallCorrelationData gmallCorrelationData= (GmallCorrelationData) correlationData;</span><br><span class="line">        <span class="comment">//获取重试次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> gmallCorrelationData.getRetryCount();</span><br><span class="line">        <span class="comment">//判断</span></span><br><span class="line">        <span class="keyword">if</span>(retryCount&gt;<span class="number">3</span>)&#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;重试次数已到，结束吧&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            retryCount+=<span class="number">1</span>;</span><br><span class="line">            gmallCorrelationData.setRetryCount(retryCount);</span><br><span class="line">            <span class="comment">//更新redis</span></span><br><span class="line">            redisTemplate.opsForValue().set(gmallCorrelationData.getId(), JSON.toJSONString(gmallCorrelationData));</span><br><span class="line">            System.out.println(<span class="string">&quot;重试次数：\t&quot;</span>+retryCount);</span><br><span class="line">            <span class="comment">//重新发送</span></span><br><span class="line">            <span class="built_in">this</span>.rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(),gmallCorrelationData.getRoutingKey(),</span><br><span class="line">                    gmallCorrelationData.getMessage(),gmallCorrelationData);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息封装</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> massage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange,String routingKey,Object massage)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建实体类封装消息信息</span></span><br><span class="line">        GmallCorrelationData gmallCorrelationData=<span class="keyword">new</span> <span class="title class_">GmallCorrelationData</span>();</span><br><span class="line">        <span class="comment">//设置id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">correlationDataId</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">       </span><br><span class="line">        gmallCorrelationData.setId(correlationDataId);</span><br><span class="line">        <span class="comment">//设置消息</span></span><br><span class="line">        gmallCorrelationData.setMessage(massage);</span><br><span class="line">        <span class="comment">//设置交换机</span></span><br><span class="line">        gmallCorrelationData.setExchange(exchange);</span><br><span class="line">        <span class="comment">//设置路由</span></span><br><span class="line">        gmallCorrelationData.setRoutingKey(routingKey);</span><br><span class="line">        <span class="comment">//存储到redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(correlationDataId, JSON.toJSONString(gmallCorrelationData),<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(exchange,routingKey,massage);</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchange,routingKey,massage,gmallCorrelationData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-4发送消息"><a href="#11-4发送消息" class="headerlink" title="11.4发送消息"></a>11.4发送消息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/mq&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息发送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//http://localhost:8282/mq/sendConfirm</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendConfirm&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">sendConfirm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//rabbitService.sendMessage(&quot;exchange.confirm&quot;,&quot;routing.confirm&quot;,&quot;生产者:发送消息...........&quot;);</span></span><br><span class="line">        <span class="comment">//1.交换机错误</span></span><br><span class="line">        <span class="comment">//rabbitService.sendMessage(&quot;exchange.confirm。error&quot;,&quot;routing.confirm&quot;,&quot;生产者:发送消息...........&quot;);</span></span><br><span class="line">        <span class="comment">//2.队列错误</span></span><br><span class="line">        rabbitService.sendMessage(<span class="string">&quot;exchange.confirm&quot;</span>,<span class="string">&quot;routing.confirm.error&quot;</span>,<span class="string">&quot;生产者:发送消息...........&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="11-5接收消息"><a href="#11-5接收消息" class="headerlink" title="11.5接收消息"></a>11.5接收消息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(value = &quot;queue.confirm&quot;,autoDelete = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = &quot;exchange.confirm&quot;,autoDelete = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            key = &#123;&quot;routing.confirm&quot;&#125;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Message message, Channel channel)</span>&#123;</span><br><span class="line">        <span class="comment">//1.接受消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;监听器:&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        System.out.println(<span class="string">&quot;接受消息成功...................&quot;</span>);</span><br><span class="line">        <span class="comment">//2.手动确认</span></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="12-Springboot延迟队列"><a href="#12-Springboot延迟队列" class="headerlink" title="12.Springboot延迟队列"></a>12.Springboot延迟队列</h1><h2 id="12-1-基于死信实现延迟消息"><a href="#12-1-基于死信实现延迟消息" class="headerlink" title="12.1 基于死信实现延迟消息"></a>12.1 基于死信实现延迟消息</h2><h3 id="12-1-1消息的TTL（Time-To-Live）"><a href="#12-1-1消息的TTL（Time-To-Live）" class="headerlink" title="12.1.1消息的TTL（Time To Live）"></a>12.1.1消息的TTL（Time To Live）</h3><p>消息的TTL就是消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL。对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。<br>      如何设置TTL：我们创建一个队列queue.temp，在Arguments 中添加x-message-ttl 为5000 （单位是毫秒），那所有压在这个队列的消息在5秒后会消失。</p>
<h3 id="12-1-2死信交换机-Dead-Letter-Exchanges"><a href="#12-1-2死信交换机-Dead-Letter-Exchanges" class="headerlink" title="12.1.2死信交换机  Dead Letter Exchanges"></a><strong>12.1.2死信交换机  Dead Letter Exchanges</strong></h3><p>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列，一个路由可以对应很多队列。<br>  （1） 一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。<br>  （2）上面的消息的TTL到了，消息过期了。<br>  （3）队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上<br>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。<br>              <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/09/11-41-13-1684470776811-dcbcdf94-1943-4e8b-90ea-9496adf7ba3b-4c97e6.png" alt="image.png"></p>
<hr>
<h3 id="12-1-3-延迟队列的代码实现"><a href="#12-1-3-延迟队列的代码实现" class="headerlink" title="12.1.3 延迟队列的代码实现"></a>12.1.3 延迟队列的代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterMqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_dead</span> <span class="operator">=</span> <span class="string">&quot;exchange.dead&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_1</span> <span class="operator">=</span> <span class="string">&quot;routing.dead.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_2</span> <span class="operator">=</span> <span class="string">&quot;routing.dead.2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_1</span> <span class="operator">=</span> <span class="string">&quot;queue.dead.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_2</span> <span class="operator">=</span> <span class="string">&quot;queue.dead.2&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.定义交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">exchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(exchange_dead,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue1</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,exchange_dead);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,routing_dead_2);</span><br><span class="line">        <span class="comment">// 设置延迟时间</span></span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_dead_1,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 将队列一 通过routing_dead_1 key 绑定到exchange_dead 交换机上</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue1()).to(exchange()).with(routing_dead_1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个队列二就是一个普通队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_dead_2,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置队列二的绑定规则</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 将队列二通过routing_dead_2 key 绑定到exchange_dead交换机上！</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue2()).to(exchange()).with(routing_dead_2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;sendDeadLettle&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">sendDeadLettle</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">       <span class="built_in">this</span>.rabbitTemplate.convertAndSend(DeadLetterMqConfig.exchange_dead, DeadLetterMqConfig.routing_dead_1, <span class="string">&quot;ok&quot;</span>);</span><br><span class="line">       System.out.println(sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot; Delay sent.&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> Result.ok();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterMqConfig.queue_dead_2)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Receive:&quot;</span> + msg);</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Receive queue_dead_2: &quot;</span> + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot; Delay rece.&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Receive:ok</span><br><span class="line">Receive queue_dead_2: <span class="number">2023</span>-<span class="number">05</span>-<span class="number">19</span> <span class="number">12</span>:<span class="number">48</span>:<span class="number">53</span> Delay rece.ok</span><br></pre></td></tr></table></figure>

<h2 id="12-2基于延迟插件实现延迟消息"><a href="#12-2基于延迟插件实现延迟消息" class="headerlink" title="12.2基于延迟插件实现延迟消息"></a>12.2基于延迟插件实现延迟消息</h2><p>Rabbitmq实现了一个插件x-delay-message来实现延时队列</p>
<ol>
<li>首先我们将刚下载下来的rabbitmq_delayed_message_exchange-3.8.0.ez文件上传到RabbitMQ所在服务器，下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></li>
<li>切换到插件所在目录，执行 docker cp rabbitmq_delayed_message_exchange-3.8.0.ez rabbitmq:&#x2F;plugins 命令，将刚插件拷贝到容器内plugins目录下</li>
<li>执行 docker exec -it rabbitmq &#x2F;bin&#x2F;bash 命令进入到容器内部，并 cd plugins 进入plugins目录</li>
<li>执行 ls -l|grep delay  命令查看插件是否copy成功</li>
<li>在容器内plugins目录下，执行 rabbitmq-plugins enable rabbitmq_delayed_message_exchange  命令启用插件</li>
<li>exit命令退出RabbitMQ容器内部，然后执行 docker restart rabbitmq 命令重启RabbitMQ容器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.CustomExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedMqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_delay</span> <span class="operator">=</span> <span class="string">&quot;exchange.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_delay</span> <span class="operator">=</span> <span class="string">&quot;routing.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_delay_1</span> <span class="operator">=</span> <span class="string">&quot;queue.delay.1&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQeue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 第一个参数是创建的queue的名字，第二个参数是是否支持持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_delay_1, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//插件方式</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>,<span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(exchange_delay, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayBbinding1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQeue1()).to(delayExchange()).with(routing_delay).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;sendDelay&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendDelay</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.rabbitTemplate.convertAndSend(DelayedMqConfig.exchange_delay, DelayedMqConfig.routing_delay, sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()), <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            message.getMessageProperties().setDelay(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">            System.out.println(sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot; Delay sent.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayedMqConfig.queue_delay_1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Receive queue_delay_1: &quot;</span> + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot; Delay rece.&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="12-2-1幂等性处理"><a href="#12-2-1幂等性处理" class="headerlink" title="12.2.1幂等性处理"></a>12.2.1幂等性处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.gmall.mq.receiver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.mq.config.DelayedMqConfig;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现幂等性思路：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   1.是否接收消息添加标记</span></span><br><span class="line"><span class="comment">     *     reids setNx</span></span><br><span class="line"><span class="comment">     *   2.如果redis中存在了，一定是消费了吗？</span></span><br><span class="line"><span class="comment">     *       未消费 0</span></span><br><span class="line"><span class="comment">     *       消费  1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayedMqConfig.queue_delay_1)</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getMessage</span><span class="params">(String msg, Message message, Channel channel)</span>&#123;</span><br><span class="line"></span><br><span class="line">        String delayKey=<span class="string">&quot;delayed:&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置消息到redis --第一次  true</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(delayKey + msg, <span class="string">&quot;0&quot;</span>, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//判断</span></span><br><span class="line">        <span class="keyword">if</span>(!result)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断是否消费</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> (String) <span class="built_in">this</span>.redisTemplate.opsForValue().get(delayKey + msg);</span><br><span class="line">            <span class="comment">//判断</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;1&quot;</span>.equals(flag))&#123;</span><br><span class="line">                channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                SimpleDateFormat simpleDateFormat=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd  HH:mm:ss&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;消息接收的时间：\t&quot;</span>+simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">                System.out.println(<span class="string">&quot;消息的内容是：&quot;</span>+msg);</span><br><span class="line">                <span class="comment">//设置消息标识为1</span></span><br><span class="line">                <span class="built_in">this</span>.redisTemplate.opsForValue().set(delayKey + msg,<span class="string">&quot;1&quot;</span>,<span class="number">10</span>,TimeUnit.MINUTES);</span><br><span class="line">                channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            SimpleDateFormat simpleDateFormat=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd  HH:mm:ss&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;消息接收的时间：\t&quot;</span>+simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">            System.out.println(<span class="string">&quot;消息的内容是：&quot;</span>+msg);</span><br><span class="line">            <span class="comment">//设置消息标识为1</span></span><br><span class="line">            <span class="built_in">this</span>.redisTemplate.opsForValue().set(delayKey + msg,<span class="string">&quot;1&quot;</span>,<span class="number">10</span>,TimeUnit.MINUTES);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="12-2-2-重试机制"><a href="#12-2-2-重试机制" class="headerlink" title="12.2.2 重试机制"></a>12.2.2 重试机制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.gmall.common.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.model.GmallCorrelationData;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerAckConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback,RabbitTemplate.ReturnCallback &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span>  RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@PostConstruct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  确认消息是否到达交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;消息发送成功：&quot;</span> + JSON.toJSONString(correlationData));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;消息发送失败：&quot;</span> + cause + <span class="string">&quot; 数据：&quot;</span> + JSON.toJSONString(correlationData));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.retryMessage(correlationData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确实消息是否正确到达队列</span></span><br><span class="line"><span class="comment">     * 执行时机：</span></span><br><span class="line"><span class="comment">     *  到达不执行</span></span><br><span class="line"><span class="comment">     *  没到执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyText</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message,<span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消息主体: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        System.out.println(<span class="string">&quot;应答码: &quot;</span> + replyCode);</span><br><span class="line">        System.out.println(<span class="string">&quot;描述：&quot;</span> + replyText);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息使用的交换器 exchange : &quot;</span> + exchange);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息使用的路由键 routing : &quot;</span> + routingKey);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从redis中获取数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">correlationDataId</span> <span class="operator">=</span> (String) message.getMessageProperties().getHeaders().get(<span class="string">&quot;spring_returned_message_correlation&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isEmpty(correlationDataId))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//从redis中获取数据</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">strJson</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(correlationDataId);</span><br><span class="line"></span><br><span class="line">            GmallCorrelationData gmallCorrelationData= JSON.parseObject(strJson, GmallCorrelationData.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用重试方法</span></span><br><span class="line">            <span class="built_in">this</span>.retryMessage(gmallCorrelationData);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现重试方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retryMessage</span><span class="params">(CorrelationData correlationData)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换</span></span><br><span class="line">        GmallCorrelationData gmallCorrelationData= (GmallCorrelationData) correlationData;</span><br><span class="line">        <span class="comment">//获取重试次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> gmallCorrelationData.getRetryCount();</span><br><span class="line">        <span class="comment">//判断</span></span><br><span class="line">        <span class="keyword">if</span>(retryCount&gt;<span class="number">3</span>)&#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;重试次数已到，结束吧&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            retryCount+=<span class="number">1</span>;</span><br><span class="line">            gmallCorrelationData.setRetryCount(retryCount);</span><br><span class="line">            <span class="comment">//更新redis</span></span><br><span class="line">            redisTemplate.opsForValue().set(gmallCorrelationData.getId(), JSON.toJSONString(gmallCorrelationData));</span><br><span class="line">            System.out.println(<span class="string">&quot;重试次数：\t&quot;</span>+retryCount);</span><br><span class="line">            <span class="comment">//判断是否延迟</span></span><br><span class="line">            <span class="keyword">if</span>(gmallCorrelationData.isDelay())&#123;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(),gmallCorrelationData.getRoutingKey(),</span><br><span class="line">                        gmallCorrelationData.getMessage(),message -&gt; &#123;</span><br><span class="line"></span><br><span class="line">                            message.getMessageProperties().setDelay(gmallCorrelationData.getDelayTime()*<span class="number">1000</span>);</span><br><span class="line">                        <span class="keyword">return</span> message;</span><br><span class="line">                        &#125;,gmallCorrelationData);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//重新发送</span></span><br><span class="line">                <span class="built_in">this</span>.rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(),gmallCorrelationData.getRoutingKey(),</span><br><span class="line">                        gmallCorrelationData.getMessage(),gmallCorrelationData);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="12-2-3-延迟消息发送封装"><a href="#12-2-3-延迟消息发送封装" class="headerlink" title="12.2.3 延迟消息发送封装"></a>12.2.3 延迟消息发送封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> meggage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange,String routingKey,Object meggage)</span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(exchange,routingKey,meggage);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送延迟消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayTime 单位：秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendDelayMessage</span><span class="params">(String exchange, String routingKey, Object message, <span class="type">int</span> delayTime)</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.rabbitTemplate.convertAndSend(exchange,routingKey,message,msg -&gt; &#123;</span><br><span class="line">              <span class="comment">//设置消息延迟时间</span></span><br><span class="line">              msg.getMessageProperties().setDelay(delayTime*<span class="number">1000</span>);</span><br><span class="line">              <span class="keyword">return</span>  msg;</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">return</span>  <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderCanelMqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">Queue</span>(MqConst.QUEUE_ORDER_CANCEL,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-delayed-type&quot;</span>,<span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(MqConst.EXCHANGE_DIRECT_ORDER_CANCEL,<span class="string">&quot;x-delayed-message&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列与交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDelay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQueue()).to(delayExchange()).with(MqConst.ROUTING_ORDER_CANCEL).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="12-3超时订单关闭"><a href="#12-3超时订单关闭" class="headerlink" title="12.3超时订单关闭"></a>12.3超时订单关闭</h2><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.gmall.order.config;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.common.constant.MqConst;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.CustomExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderCanelMqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">Queue</span>(MqConst.QUEUE_ORDER_CANCEL,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-delayed-type&quot;</span>,<span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(MqConst.EXCHANGE_DIRECT_ORDER_CANCEL,<span class="string">&quot;x-delayed-message&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列与交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDelay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQueue()).to(delayExchange()).with(MqConst.ROUTING_ORDER_CANCEL).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveOrderInfo</span><span class="params">(OrderInfo orderInfo)</span> &#123;</span><br><span class="line">        orderInfo.sumTotalAmount();</span><br><span class="line">        <span class="comment">//1.设置支付状态</span></span><br><span class="line">        orderInfo.setOrderStatus(OrderStatus.UNPAID.name());</span><br><span class="line">        <span class="comment">//2.设置订单交易号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">outTradeNo</span> <span class="operator">=</span> <span class="string">&quot;ATGUIGU&quot;</span> + System.currentTimeMillis() + <span class="string">&quot;&quot;</span> + <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>);</span><br><span class="line">        orderInfo.setOutTradeNo(outTradeNo);</span><br><span class="line">        <span class="comment">//3.设置创建时间</span></span><br><span class="line">        orderInfo.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//4.设置过期时间</span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        <span class="comment">//日期加一天</span></span><br><span class="line">        calendar.add(Calendar.DATE,<span class="number">1</span>);</span><br><span class="line">        orderInfo.setExpireTime(calendar.getTime());</span><br><span class="line">        <span class="comment">//5.设置支付处理状态</span></span><br><span class="line">        orderInfo.setProcessStatus(ProcessStatus.UNPAID.name());</span><br><span class="line">        <span class="comment">//6.获取订单明细</span></span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = orderInfo.getOrderDetailList();</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">tradeBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">for</span> (OrderDetail orderDetail : orderDetailList) &#123;</span><br><span class="line">            tradeBody.append(orderDetail.getSkuName()+<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (tradeBody.toString().length()&gt;<span class="number">100</span>)&#123;</span><br><span class="line">            orderInfo.setTradeBody(tradeBody.toString().substring(<span class="number">0</span>,<span class="number">100</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            orderInfo.setTradeBody(tradeBody.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7.保存订单信息</span></span><br><span class="line">        orderInfoMapper.insert(orderInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//8.保存订单详情</span></span><br><span class="line">        <span class="keyword">for</span> (OrderDetail orderDetail : orderDetailList) &#123;</span><br><span class="line">            orderDetail.setOrderId(orderInfo.getId());</span><br><span class="line">            orderDetailMapper.insert(orderDetail);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送延迟队列，如果定时未支付，取消订单</span></span><br><span class="line">        rabbitService.sendDelayMessage(MqConst.EXCHANGE_DIRECT_ORDER_CANCEL, MqConst.ROUTING_ORDER_CANCEL, orderInfo.getId(), MqConst.DELAY_TIME);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//9.返回订单Id</span></span><br><span class="line">        <span class="keyword">return</span> orderInfo.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.gmall.order.receiver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.model.order.OrderInfo;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = MqConst.QUEUE_ORDER_CANCEL)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancelOrder</span><span class="params">(Long orderId , Message message, Channel channel)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">             <span class="keyword">if</span> (orderId!=<span class="literal">null</span>)&#123;</span><br><span class="line">                 <span class="comment">//  发过来的是订单Id，那么你就需要判断一下当前的订单是否已经支付了。</span></span><br><span class="line">                 <span class="comment">//  未支付的情况下：关闭订单</span></span><br><span class="line">                 <span class="comment">//  根据订单Id 查询orderInfo select * from order_info where id = orderId</span></span><br><span class="line">                 <span class="comment">//  利用这个接口IService  实现类ServiceImpl 完成根据订单Id 查询订单信息 ServiceImpl 类底层还是使用的mapper</span></span><br><span class="line">                 <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">                 <span class="keyword">if</span> (orderInfo!=<span class="literal">null</span>&amp;&amp;<span class="string">&quot;UNPAID&quot;</span>.equals(orderInfo.getOrderStatus())&amp;&amp;<span class="string">&quot;UNPAID&quot;</span>.equals(orderInfo.getProcessStatus()))&#123;</span><br><span class="line">                        <span class="comment">//关闭订单</span></span><br><span class="line">                     orderService.execExpiredOrder(orderId);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execExpiredOrder</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// orderInfo</span></span><br><span class="line">    updateOrderStatus(orderId, ProcessStatus.CLOSED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateOrderStatus</span><span class="params">(Long orderId, ProcessStatus processStatus)</span> &#123;</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">    orderInfo.setId(orderId);</span><br><span class="line">    orderInfo.setProcessStatus(processStatus.name());</span><br><span class="line">    orderInfo.setOrderStatus(processStatus.getOrderStatus().name());</span><br><span class="line">    orderInfoMapper.updateById(orderInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-13-21-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623031309-4c1443.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-13-21-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623031309-4c1443.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Flaw</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://lisianthusw.github.io/2024/08/09/RabbitMQ%E7%9F%A5%E8%AF%86%E5%BA%93/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://lisianthusw.github.io/2024/08/09/RabbitMQ%E7%9F%A5%E8%AF%86%E5%BA%93/')">RabbitMQ[复盘]</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030747-010bf4.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030747-010bf4.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030743-4e58a3.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-08-09-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623030743-4e58a3.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://lisianthusw.github.io/2024/08/09/RabbitMQ%E7%9F%A5%E8%AF%86%E5%BA%93/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=RabbitMQ[复盘]&amp;url=http://lisianthusw.github.io/2024/08/09/RabbitMQ%E7%9F%A5%E8%AF%86%E5%BA%93/&amp;pic=https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/17/17-54-55-image-20210717162752376-fb7887.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://LisianthusW.github.io" target="_blank">卿云</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>系统架构<span class="tagsPageCount">27</span></a><a class="post-meta__box__tags" href="/tags/RabbitMQ/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>RabbitMQ<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>消息队列<span class="tagsPageCount">3</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/15-24-35-135653-yue_liang-yu_hang_yuan-yu_zhou-wai_ceng_kong_jian-tian_kong-500x-e0388a.jpeg?_r_=3c6adafa-67db-e458-e1f0-532693e0a24d" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/09/install-mysql/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/28/20-57-27-u=1343390411,2097378757undefinedfm=253undefinedfmt=autoundefinedapp=120undefinedf=JPEG-bfd69b.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">install-mysql</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/12/Git%E6%8F%90%E4%BA%A4%E8%A7%84%E8%8C%83/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/16/16-54-04-1_mSE6ialQ-9TcGUz5ts_FMA-31fdf3.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Git提交规范</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/07/17/RabbitMQ/" title="RabbitMQ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/17/17-54-55-image-20210717162752376-fb7887.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-17</div><div class="title">RabbitMQ</div></div></a></div><div><a href="/2024/07/17/SpringAMQP/" title="SpringAMQP"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/17/17-58-53-image-20210717164024967-f20fae.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-17</div><div class="title">SpringAMQP</div></div></a></div><div><a href="/2024/08/06/App%E9%80%86%E5%90%91/" title="App逆向"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/08/06/14-59-31-1649320678-64bd8595e400c44-0f8d39.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-06</div><div class="title">App逆向</div></div></a></div><div><a href="/2024/07/16/Centos7%E5%AE%89%E8%A3%85galances/" title="Centos7安装galances"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/16/19-18-49-12842148908d4a62b4586f8bb143fedb-195d14.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">Centos7安装galances</div></div></a></div><div><a href="/2024/07/24/CI%E3%80%81CD%E5%85%A5%E9%97%A8%E6%93%8D%E4%BD%9C/" title="DevOps搭建(四)-CI、CD入门操作[CI,CD,GitLab,Jenkins]"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/24/15-17-55-2021-11-23_175935-789003.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-24</div><div class="title">DevOps搭建(四)-CI、CD入门操作[CI,CD,GitLab,Jenkins]</div></div></a></div><div><a href="/2024/07/24/DevOps%E6%90%AD%E5%BB%BA-Code%E9%98%B6%E6%AE%B5/" title="DevOps搭建(一)-Code阶段[Git,GitLab]"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/07/24/15-17-55-2021-11-23_175935-789003.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-24</div><div class="title">DevOps搭建(一)-Code阶段[Git,GitLab]</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/03-13-21-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240623031309-4c1443.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">Flaw</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/LisianthusW" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://img02.anheyu.com/adminuploads/1/2022/09/11/631ddb7c9b250.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://img02.anheyu.com/adminuploads/1/2022/09/11/631ddb7c9b250.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">1.1概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-QPS%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1.1.1 QPS概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2PV-UV-PR"><span class="toc-number">1.2.</span> <span class="toc-text">1.1.2PV UV PR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">1.2.消息队列应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6"><span class="toc-number">2.1.</span> <span class="toc-text">1.2.1应用解耦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">1.2.2.异步处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0"><span class="toc-number">2.3.</span> <span class="toc-text">1.2.3.流量削峰</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9B%B8%E5%85%B3%E4%BB%8B%E7%BB%8D"><span class="toc-number"></span> <span class="toc-text">2.消息队列相关介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-AMQP"><span class="toc-number">0.1.</span> <span class="toc-text">2.2.1. AMQP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-JMS"><span class="toc-number">0.2.</span> <span class="toc-text">2.2.2. JMS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-AMQP-%E4%B8%8E-JMS-%E5%8C%BA%E5%88%AB"><span class="toc-number">0.3.</span> <span class="toc-text">2.2.3. AMQP 与 JMS 区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-RabbitMQ%E7%AE%80%E4%BB%8B"><span class="toc-number">0.4.</span> <span class="toc-text">2.2.4 RabbitMQ简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-RabbitMQ-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">0.5.</span> <span class="toc-text">2.2.5 RabbitMQ 中的相关概念</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-RabbitMQ%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AE"><span class="toc-number"></span> <span class="toc-text">3.RabbitMQ安装及配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E4%B8%8B%E8%BD%BD%E5%8C%85"><span class="toc-number">1.</span> <span class="toc-text">3.1下载包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">3.2安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85Erlang%E3%80%81Socat%E3%80%81RabbitMQ"><span class="toc-number">2.1.</span> <span class="toc-text">1.安装Erlang、Socat、RabbitMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%90%AF%E7%94%A8%E7%AE%A1%E7%90%86%E6%8F%92%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">2.启用管理插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%90%AF%E5%8A%A8RabbitMQ"><span class="toc-number">2.3.</span> <span class="toc-text">3.启动RabbitMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.4.</span> <span class="toc-text">4.查看进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.5.</span> <span class="toc-text">5.测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%A2%9E%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%A6%E5%8F%B7"><span class="toc-number">2.6.</span> <span class="toc-text">6.增加自定义账号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%8D%B8%E8%BD%BD"><span class="toc-number">2.7.</span> <span class="toc-text">7.卸载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2"><span class="toc-number">3.</span> <span class="toc-text">3.3管理界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-AMQP"><span class="toc-number"></span> <span class="toc-text">4.AMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">4.1. 相关概念介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-RabbitMQ%E8%BF%90%E8%BD%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">4.2. RabbitMQ运转流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-RabbitMQ%E5%85%A5%E9%97%A8%E6%A1%88%E5%88%97"><span class="toc-number"></span> <span class="toc-text">5.RabbitMQ入门案列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E5%85%A5%E9%97%A8%E6%A1%88%E5%88%97"><span class="toc-number">1.</span> <span class="toc-text">5.1入门案列</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-RabbitMQ%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number"></span> <span class="toc-text">6.RabbitMQ工作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">6.1 简单模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">6.1.1概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">6.1.2 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">6.2 发布订阅模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.</span> <span class="toc-text">6.2.1模式说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">6.2.2 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3Routing%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">6.3Routing路由模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">3.1.</span> <span class="toc-text">6.3.1模式说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.2.</span> <span class="toc-text">6.3.2代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-Topics%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">6.4 Topics通配符模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">4.1.</span> <span class="toc-text">6.4.1模式说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.</span> <span class="toc-text">6.4.2 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">6.5工作模式总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Spring%E6%95%B4%E5%90%88RabbitMQ"><span class="toc-number"></span> <span class="toc-text">7.Spring整合RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E7%94%9F%E4%BA%A7%E8%80%85%E7%AB%AF"><span class="toc-number">1.</span> <span class="toc-text">7.1 生产者端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E6%B6%88%E8%B4%B9%E8%80%85%E7%AB%AF"><span class="toc-number">2.</span> <span class="toc-text">7.2.消费者端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-RabbitMQ%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-number"></span> <span class="toc-text">8.RabbitMQ高级特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BC%A0%E9%80%92%EF%BC%88%E5%8F%91%E9%80%81%E7%AB%AF%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">8.1消息的可靠性传递（发送端）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-Confirm%E7%A1%AE%E8%AE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">8.1.1 Confirm确认模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2-Return%E9%80%80%E5%9B%9E%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">8.1.2 Return退回模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-3%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92%E5%B0%8F%E7%BB%93"><span class="toc-number">1.3.</span> <span class="toc-text">8.1.3消息的可靠投递小结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-4Consumer-Ack%EF%BC%88%E6%8E%A5%E6%94%B6%E7%AB%AF%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">8.1.4Consumer Ack（接收端）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2%E6%B6%88%E8%B4%B9%E9%99%90%E6%B5%81"><span class="toc-number">2.</span> <span class="toc-text">8.2消费限流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3TTL"><span class="toc-number">3.</span> <span class="toc-text">8.3TTL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1-%E9%85%8D%E7%BD%AE%E9%98%9F%E5%88%97%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">3.1.</span> <span class="toc-text">8.3.1 配置队列过期时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-2-%E6%B6%88%E6%81%AF%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">3.2.</span> <span class="toc-text">8.3.2 消息过期时间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">4.</span> <span class="toc-text">8.4死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-1%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">4.1.</span> <span class="toc-text">8.4.1什么是死信队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-2-%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81"><span class="toc-number">4.2.</span> <span class="toc-text">8.4.2 过期时间处理代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-3-%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6%E5%A4%84%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">8.4.3 长度限制处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-4%E6%B6%88%E6%81%AF%E6%8B%92%E6%94%B6"><span class="toc-number">4.4.</span> <span class="toc-text">8.4.4消息拒收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-number">5.</span> <span class="toc-text">8.5 延迟队列</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-SpringBoot%E9%9B%86%E6%88%90MQ"><span class="toc-number"></span> <span class="toc-text">9.SpringBoot集成MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1%E6%95%B4%E5%90%88"><span class="toc-number">1.</span> <span class="toc-text">9.1整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-2%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">1.1.</span> <span class="toc-text">9.1.2生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-3%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.2.</span> <span class="toc-text">9.1.3消费者</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1SpringBoot%E5%9C%A8%E6%B6%88%E8%B4%B9%E7%AB%AF%E7%BB%91%E5%AE%9A"><span class="toc-number">2.</span> <span class="toc-text">9.1SpringBoot在消费端绑定</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%B6%88%E6%81%AF%E7%99%BE%E5%88%86%E7%99%BE%E6%88%90%E5%8A%9F%E6%8A%95%E9%80%92"><span class="toc-number"></span> <span class="toc-text">10.消息百分百成功投递</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E7%94%9F%E4%BA%A7%E8%80%85%E7%AB%AF"><span class="toc-number">1.</span> <span class="toc-text">10.1 生产者端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E6%B6%88%E8%B4%B9%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">10.2 消费幂等性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-Springboot%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4"><span class="toc-number"></span> <span class="toc-text">11.Springboot消息确认</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">11.1 搭建环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E7%94%9F%E4%BA%A7%E7%AB%AF%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E9%85%8D%E7%BD%AE1"><span class="toc-number">2.</span> <span class="toc-text">11.2 生产端消息确认配置1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3%E7%94%9F%E4%BA%A7%E7%AB%AF%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E9%85%8D%E7%BD%AE-%EF%BC%88%E7%99%BE%E5%88%86%E7%99%BE%E5%8F%91%E9%80%81%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">11.3生产端消息确认配置:（百分百发送）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-4%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">4.</span> <span class="toc-text">11.4发送消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-5%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-number">5.</span> <span class="toc-text">11.5接收消息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-Springboot%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-number"></span> <span class="toc-text">12.Springboot延迟队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1-%E5%9F%BA%E4%BA%8E%E6%AD%BB%E4%BF%A1%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">12.1 基于死信实现延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-1%E6%B6%88%E6%81%AF%E7%9A%84TTL%EF%BC%88Time-To-Live%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">12.1.1消息的TTL（Time To Live）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-2%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA-Dead-Letter-Exchanges"><span class="toc-number">1.2.</span> <span class="toc-text">12.1.2死信交换机  Dead Letter Exchanges</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-3-%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">12.1.3 延迟队列的代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2%E5%9F%BA%E4%BA%8E%E5%BB%B6%E8%BF%9F%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">2.</span> <span class="toc-text">12.2基于延迟插件实现延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-1%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">12.2.1幂等性处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-2-%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.</span> <span class="toc-text">12.2.2 重试机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-3-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E5%B0%81%E8%A3%85"><span class="toc-number">2.3.</span> <span class="toc-text">12.2.3 延迟消息发送封装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3%E8%B6%85%E6%97%B6%E8%AE%A2%E5%8D%95%E5%85%B3%E9%97%AD"><span class="toc-number">3.</span> <span class="toc-text">12.3超时订单关闭</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text"></span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/05/07/UnityDOTS%E5%AD%A6%E4%B9%A0/" title="UnityDOTS学习"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/15-24-35-135653-yue_liang-yu_hang_yuan-yu_zhou-wai_ceng_kong_jian-tian_kong-500x-e0388a.jpeg?_r_=3c6adafa-67db-e458-e1f0-532693e0a24d" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UnityDOTS学习"/></a><div class="content"><a class="title" href="/2025/05/07/UnityDOTS%E5%AD%A6%E4%B9%A0/" title="UnityDOTS学习">UnityDOTS学习</a><time datetime="2025-05-07T06:45:04.000Z" title="发表于 2025-05-07 14:45:04">2025-05-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/07/cursor%E8%A7%84%E5%88%99/" title="cursor规则"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/15-25-39-176476-dong_hua_pian-tao-fa_xing-zui-hei_se_de-x750-664a8e.jpeg?_r_=e16253d1-3cc7-4a39-5165-8be1df12efc5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="cursor规则"/></a><div class="content"><a class="title" href="/2025/04/07/cursor%E8%A7%84%E5%88%99/" title="cursor规则">cursor规则</a><time datetime="2025-04-07T03:53:33.000Z" title="发表于 2025-04-07 11:53:33">2025-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/09/%E6%98%93%E4%BC%98%E8%AF%8420250309%E5%90%8E%E7%AB%AF%E9%87%8D%E6%9E%84/" title="易优评20250309后端重构"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/15-25-39-176476-dong_hua_pian-tao-fa_xing-zui-hei_se_de-x750-664a8e.jpeg?_r_=805e1346-f7ec-34e0-1ca9-ea4fc21ef5eb" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="易优评20250309后端重构"/></a><div class="content"><a class="title" href="/2025/03/09/%E6%98%93%E4%BC%98%E8%AF%8420250309%E5%90%8E%E7%AB%AF%E9%87%8D%E6%9E%84/" title="易优评20250309后端重构">易优评20250309后端重构</a><time datetime="2025-03-08T16:11:25.000Z" title="发表于 2025-03-09 00:11:25">2025-03-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/07/%E6%9F%90%E5%8E%BF%E6%B0%B4%E8%B5%84%E6%BA%90/" title="某县水资源"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/15-24-35-135653-yue_liang-yu_hang_yuan-yu_zhou-wai_ceng_kong_jian-tian_kong-500x-e0388a.jpeg?_r_=364d45e4-9797-d4b6-4db9-dddd8ddaa238" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="某县水资源"/></a><div class="content"><a class="title" href="/2025/03/07/%E6%9F%90%E5%8E%BF%E6%B0%B4%E8%B5%84%E6%BA%90/" title="某县水资源">某县水资源</a><time datetime="2025-03-07T06:06:38.000Z" title="发表于 2025-03-07 14:06:38">2025-03-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/04/AI%E6%8F%90%E7%A4%BA%E8%AF%8D/" title="AI提示词"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/LisianthusW/pic_bed@main/images/2024/06/23/15-26-20-117730-bei_shang-shou_bi-zhang_zhang_de_tou_fa-cao_tu-ai_qing-500x-397dd1.jpeg?_r_=8d661635-3f1a-3977-0515-27aedb3e47a3" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI提示词"/></a><div class="content"><a class="title" href="/2025/03/04/AI%E6%8F%90%E7%A4%BA%E8%AF%8D/" title="AI提示词">AI提示词</a><time datetime="2025-03-04T15:56:53.000Z" title="发表于 2025-03-04 23:56:53">2025-03-04</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="Flaw" target="_blank">Flaw</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/LisianthusW" title="Github">Github</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">134</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">116</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">25</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://LisianthusW.github.io/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://chat.qingyunzc.cc" title="卿云AI"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="卿云AI"/><span class="back-menu-item-text">卿云AI</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/?id=6799820199&amp;server=netease"><span> 音乐馆</span></a></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Activiti7/" style="font-size: 0.88rem;">Activiti7<sup>4</sup></a><a href="/tags/Android/" style="font-size: 0.88rem;">Android<sup>1</sup></a><a href="/tags/AndroidAPI/" style="font-size: 0.88rem;">AndroidAPI<sup>1</sup></a><a href="/tags/DevOps/" style="font-size: 0.88rem;">DevOps<sup>5</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>1</sup></a><a href="/tags/Docker%E5%AE%89%E8%A3%85/" style="font-size: 0.88rem;">Docker安装<sup>1</sup></a><a href="/tags/EDA/" style="font-size: 0.88rem;">EDA<sup>1</sup></a><a href="/tags/Eureka/" style="font-size: 0.88rem;">Eureka<sup>2</sup></a><a href="/tags/Feign/" style="font-size: 0.88rem;">Feign<sup>1</sup></a><a href="/tags/Galances/" style="font-size: 0.88rem;">Galances<sup>1</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>12</sup></a><a href="/tags/GitLab/" style="font-size: 0.88rem;">GitLab<sup>10</sup></a><a href="/tags/Github/" style="font-size: 0.88rem;">Github<sup>1</sup></a><a href="/tags/Gitlab/" style="font-size: 0.88rem;">Gitlab<sup>2</sup></a><a href="/tags/Jar/" style="font-size: 0.88rem;">Jar<sup>2</sup></a><a href="/tags/Jenkins/" style="font-size: 0.88rem;">Jenkins<sup>8</sup></a><a href="/tags/LNMP/" style="font-size: 0.88rem;">LNMP<sup>2</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>16</sup></a><a href="/tags/Linux%E5%91%BD%E4%BB%A4/" style="font-size: 0.88rem;">Linux命令<sup>2</sup></a><a href="/tags/MYSQL/" style="font-size: 0.88rem;">MYSQL<sup>4</sup></a><a href="/tags/Nacos/" style="font-size: 0.88rem;">Nacos<sup>5</sup></a><a href="/tags/Nacos%E9%9B%86%E7%BE%A4/" style="font-size: 0.88rem;">Nacos集群<sup>1</sup></a><a href="/tags/SpringCloud/" style="font-size: 0.88rem;">SpringCloud<sup>15</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>3</sup></a><a href="/tags/mysqls/" style="font-size: 0.88rem;">mysqls<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8/" style="font-size: 0.88rem;">事件驱动<sup>1</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7/" style="font-size: 0.88rem;">内存监控<sup>1</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/" style="font-size: 0.88rem;">工作流<sup>4</sup></a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 0.88rem;">微服务<sup>10</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E5%8F%AF%E7%94%A8/" style="font-size: 0.88rem;">数据库高可用<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>10</sup></a><a href="/tags/%E6%B8%97%E9%80%8F%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">渗透系统<sup>2</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>8</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">系统架构<sup>27</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/" style="font-size: 0.88rem;">自动化运维<sup>8</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8F%91%E5%B8%83%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">自动发布系统<sup>4</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">软件系统<sup>3</sup></a><a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 0.88rem;">运维<sup>7</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B%E6%A3%80%E6%B5%8B%E4%B8%8E%E6%8E%A7%E5%88%B6/" style="font-size: 0.88rem;">进程检测与控制<sup>1</sup></a><a href="/tags/%E9%80%86%E5%90%91%E7%88%AC%E8%99%AB/" style="font-size: 0.88rem;">逆向爬虫<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="6799820199" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎您第一位访问者！!`,
    `生活明朗, 万物可爱`,
    "已上线",
    dnum,
    "天"
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Flaw 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>